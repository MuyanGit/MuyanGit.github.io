<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/MuyanGit/ImageHosting/images/剑来大小抠图/bitbug_favicon大.ico"><link rel="icon" href="https://cdn.jsdelivr.net/gh/MuyanGit/ImageHosting/images/剑来大小抠图/bitbug_favicon大.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="MuyanGit"><meta name="keywords" content=""><meta name="description" content="代码网  首页 博客 专栏  写博客登录&#x2F;注册 创作 700 0 收藏 Windows桌面程序自动化控制之uiautomation模块全面讲解 tjk   2021-11-19 11:21:52   700   0  大家好，我是小小明，经过2个月断断续续的整理，uiautomation模块桌面自动化控制的系统教程终于成型出炉了。下面是本文档的目录大纲，大家可以感受一下： 文章目录-"><meta property="og:type" content="article"><meta property="og:title" content="Windows桌面程序自动化控制之uiautomation模块全面讲解"><meta property="og:url" content="http://example.com/2022/06/08/Windows%E6%A1%8C%E9%9D%A2%E7%A8%8B%E5%BA%8F%E8%87%AA%E5%8A%A8%E5%8C%96%E6%8E%A7%E5%88%B6%E4%B9%8Buiautomation%E6%A8%A1%E5%9D%97%E5%85%A8%E9%9D%A2%E8%AE%B2%E8%A7%A3/index.html"><meta property="og:site_name" content="MuyanGit的博客"><meta property="og:description" content="代码网  首页 博客 专栏  写博客登录&#x2F;注册 创作 700 0 收藏 Windows桌面程序自动化控制之uiautomation模块全面讲解 tjk   2021-11-19 11:21:52   700   0  大家好，我是小小明，经过2个月断断续续的整理，uiautomation模块桌面自动化控制的系统教程终于成型出炉了。下面是本文档的目录大纲，大家可以感受一下： 文章目录-"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/MuyanGit/pic_url@master/img/image-20220610173600286.png"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_0.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_15.gif"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_17.gif"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_19.gif"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_21.gif"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_5.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_6.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_7.png?x-oss-process=style/watermark"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/MuyanGit/pic_url@master/img/image-20220608153123108.png"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_8.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_9.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_10.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_11.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_12.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_13.gif"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_14.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_15.gif"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_16.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_17.gif"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_18.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_19.gif"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_20.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_21.gif"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_22.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_23.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_24.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_25.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_26.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_27.gif"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_28.png?x-oss-process=style/watermark"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com//2022/2022-01/2022-01-16/daimanet.jpg?x-oss-process=style/HEADER"><meta property="og:image" content="https://daimanet.oss-cn-beijing.aliyuncs.com/index/logo.jpg?x-oss-process=style/HEADER"><meta property="og:image" content="chrome-extension:/golkpggaiebgepbccjaoifgeeemiacoo/images/logo_64.png"><meta property="article:published_time" content="2022-06-08T07:09:36.000Z"><meta property="article:modified_time" content="2022-07-17T06:03:50.691Z"><meta property="article:author" content="MuyanGit"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/MuyanGit/pic_url@master/img/image-20220610173600286.png"><title>Windows桌面程序自动化控制之uiautomation模块全面讲解 - MuyanGit的博客</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var dntVal,Fluid=window.Fluid||{},CONFIG=(Fluid.ctx=Object.assign({},Fluid.ctx),{hostname:"example.com",root:"/",version:"1.9.2",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"wrsI8VLOqU4aU1Bf7ax2ybPp-MdYXbMMI",app_key:"AEijWlUoG3pMbyJKxexAmJtN",server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"});CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.2.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>言念君子，温其如玉。</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Windows桌面程序自动化控制之uiautomation模块全面讲解"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-06-08 15:09" pubdate>2022年6月8日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 53k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 442 分钟 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">Windows桌面程序自动化控制之uiautomation模块全面讲解</h1><div class="markdown-body"><p>代码网</p><ul><li>首页</li><li>博客</li><li>专栏</li></ul><p>写博客<a href="javascript:void(0)">登录&#x2F;注册</a></p><p><a href="javascript:void(0)">创作</a></p><p><a href="javascript:void(0)">700</a></p><p><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296#comment">0</a></p><p><a href="javascript:void(0)">收藏</a></p><p><strong>Windows桌面程序自动化控制之uiautomation模块全面讲解</strong></p><p>tjk</p><p>2021-11-19 11:21:52</p><p>700</p><p>0</p><p>大家好，我是小小明，经过2个月断断续续的整理，uiautomation模块桌面自动化控制的系统教程终于成型出炉了。下面是本文档的目录大纲，大家可以感受一下：</p><h3 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h3><p>-</p><ul><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">简介</a></li><li></li><li></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">功能介绍</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">基本原理</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">控件控制入门：记事本操作</a></li><li></li><li></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">控件分析与可用参数</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">控件延迟搜索机制</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">示例：连续打开三个记事本并关闭</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">UIAutomation的常见功能</a></li><li></li><li></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">基本方法</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">获取窗口对象</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">控件查找方法</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">窗口属性调整</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">WalkTree遍历子控件</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">Bitmap位图对象的使用</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">对多个显示器分别截屏</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">剪切板操作</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">自带的Logger日志输出类</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">全局热键与多线程</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">管理员提权</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">通过实例学习UI自动化</a></li><li></li><li></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">控制win10计算器自动计算</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">窗口的拖拽与缩放</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">管理员提权操作并读取设备管理器栏目数据</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">记事本文本输入与字体调整</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">wireshark抓包数据读取</a></li><li></li><li><a target="_blank" rel="noopener" href="https://www.daima.net/blog/d6acb36960f64c9b98babcf538797296">PDF目录折叠展开提取器</a></li></ul><h1 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h1><h2 id="深度：斜杠数量-1"><a href="#深度：斜杠数量-1" class="headerlink" title="深度：斜杠数量+1"></a>深度：斜杠数量+1</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">save_Window=  auto.WindowControl(<span class="hljs-attribute">searchDepth</span>=3, <span class="hljs-attribute">ClassName</span>=<span class="hljs-string">&#x27;#32770&#x27;</span>)<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/MuyanGit/pic_url@master/img/image-20220610173600286.png" srcset="/img/loading.gif" lazyload alt="image-20220610173600286"></p><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><h2 id="功能介绍"><a href="#功能介绍" class="headerlink" title="功能介绍"></a>功能介绍</h2><p>本文档大纲：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_0.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211118101343337"></p><p>可以看到uiautomation模块除了核心功能UI控件的<strong>控制</strong>、<strong>截图</strong>和<strong>数据提取</strong>外，还支持<strong>全局热键注册</strong>、<strong>剪切板操作</strong>和<strong>管理员权限提权</strong>。</p><p>在常规的模拟鼠标和键盘操作，我们一般使用<strong>pyautogui</strong>，uiautomation模块不仅能直接支持这些操作，还能通过控件定位方式直接定位到目标控件的位置，而不需要自己去获取对应坐标位置。uiautomation模块不仅支持任意坐标位置截图，还支持目标控件的截图，缺点在于截取产生的图片对象难以直接与PIL库配合，只能导出文件后让PIL图像处理库重新读取。对于能够获取到其ScrollItemPattern对象的控件还可以通过ScrollIntoView方法进行视图定位，与游览器的元素定位效果几乎一致。</p><p>在常规的热键功能，我们一般使用pynput实现，但现在有了uiautomation模块，热键注册会比pynput更简单功能更强。uiautomation模块所支持的剪切板操作的功能也远远超过常规的专门用于剪切板复制粘贴的库。更牛的是uiautomation模块能直接支持让你的python程序实现管理员提权。</p><p>基本上这个库的功能超过好几个专门针对某个功能的库。我们可以看看一下这个库自动化操作过程的动图效果：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_15.gif" srcset="/img/loading.gif" lazyload alt="请添加图片描述"></p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_17.gif" srcset="/img/loading.gif" lazyload alt="请添加图片描述"></p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_19.gif" srcset="/img/loading.gif" lazyload alt="请添加图片描述"></p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_21.gif" srcset="/img/loading.gif" lazyload alt="请添加图片描述"></p><p>掌握这个框架之后，你能够实现的自动化效果远不止如此。</p><p>这么优秀的框架你是否心动了呢？心动不如行动，学起来吧！！！</p><h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><p>uiautomation模块项目地址：<a target="_blank" rel="noopener" href="https://github.com/yinkaisheng/Python-UIAutomation-for-Windows">https://github.com/yinkaisheng/Python-UIAutomation-for-Windows</a></p><blockquote><p>uiautomation是yinkaisheng业余时间开发一个模块。封装了微软UIAutomation API，支持自动化Win32，MFC，WPF，Modern UI(Metro UI), Qt, IE, Firefox(version&lt;&#x3D;56 or &gt;&#x3D;60), Chrome谷歌游览器和基于Electron开发的应用程序(加启动参数–force-renderer-accessibility也能支持UIAutomation被自动化). uiautomation只支持Python 3版本，依赖comtypes和typing这两个包，但Python不要使用3.7.6和3.8.1这两个版本，comtypes在这两个版本中不能正常工作（issue）。</p></blockquote><p><strong>UIAutomation的工作原理：</strong></p><p>UIAutomation操作程序时会给程序发送WM_GETOBJECT消息，如果程序处理WM_GETOBJECT消息，实现UI Automation Provider,并调用函数</p><p>**UiaReturnRawElementProvider(HWND hwnd,WPARAM wparam,LPARAM lparam,IRawElementProviderSimple *el)**，此程序就支持UIAutomation。</p><p>IRawElementProviderSimple 就是 UI Automation Provider，包含了控件的各种信息，如Name，ClassName，ContorlType，坐标等。</p><p>UIAutomation 根据程序返回的 IRawElementProviderSimple，就能遍历程序的控件，得到控件各种属性，进行自动化操作。若程序没有处理WM_GETOBJECT或没有实现UIAutomation Provider，UIAutomation则无法识别这些程序内的控件，不支持自动化。</p><p>很多DirectUI程序没有实现UIAutomation Provider，所以不支持自动化。</p><p>关于各控件所支持的控件模式，可参考：</p><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/win32/winauto/uiauto-controlpatternmapping">https://docs.microsoft.com/zh-cn/windows/win32/winauto/uiauto-controlpatternmapping</a></p><p>在使用uiautomation模块前需要先安装：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> uiautomation<br></code></pre></td></tr></table></figure><p>安装后会在python安装目录下的Scripts目录下得到一个automation.py脚本，可以使用它来准确获取目标窗口的控件结构信息。</p><p>automation.py脚本也可以从<a target="_blank" rel="noopener" href="https://github.com/yinkaisheng/Python-UIAutomation-for-Windows/raw/master/automation.py%E4%B8%8B%E8%BD%BD%E3%80%82">https://github.com/yinkaisheng/Python-UIAutomation-for-Windows/raw/master/automation.py下载。</a></p><p>当然使用windows自带的inspect.exe图形化工具来观察控件的树形结构更加，通过everything可以很快在系统中找到该工具。</p><blockquote><p>⚠️ ：inspect.exe工具获取到的控件类型可能与automation.py脚本打印的结果不太一样，如果发现控件实际不存在，要以automation.py脚本打印的结果为准。</p></blockquote><h1 id="控件控制入门：记事本操作"><a href="#控件控制入门：记事本操作" class="headerlink" title="控件控制入门：记事本操作"></a>控件控制入门：记事本操作</h1><h2 id="控件分析与可用参数"><a href="#控件分析与可用参数" class="headerlink" title="控件分析与可用参数"></a>控件分析与可用参数</h2><p>首先打开记事本窗口，并设置窗口前置：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros">import subprocess<br>import uiautomation as auto<br><br>subprocess.Popen(<span class="hljs-string">&#x27;notepad.exe&#x27;</span>)<br><span class="hljs-comment"># 从桌面的第一层子控件中找到记事本程序的窗口WindowControl</span><br>notepadWindow = auto.WindowControl(<span class="hljs-attribute">searchDepth</span>=1, <span class="hljs-attribute">ClassName</span>=<span class="hljs-string">&#x27;Notepad&#x27;</span>)<br><span class="hljs-built_in">print</span>(notepadWindow.Name)<br><span class="hljs-comment"># 设置窗口前置</span><br>notepadWindow.SetTopmost(<span class="hljs-literal">True</span>)<br>1234567<br></code></pre></td></tr></table></figure><p>运行上述代码后，会打开一个窗口前置的记事本程序。</p><p>控件可用参数说明：</p><p>-</p><ul><li><p><strong>searchFromControl &#x3D; None</strong>：从哪个控件开始查找，如果为None，从根控件Desktop开始查找</p></li><li></li><li><p><strong>searchDepth &#x3D; 0xFFFFFFFF</strong>： 搜索深度</p></li><li></li><li><p><strong>searchInterval &#x3D; SEARCH_INTERVAL</strong>：搜索间隔</p></li><li></li><li><p><strong>foundIndex &#x3D; 1</strong> ：搜索到的满足搜索条件的控件索引，索引从1开始</p></li><li></li><li><p><strong>Name</strong>：控件名字</p></li><li></li><li><p><strong>SubName</strong> ：控件部分名字</p></li><li></li><li><p><strong>RegexName</strong>：使用re.match匹配符合正则表达式的名字，Name,SubName,RegexName只能使用一个，不能同时使用</p></li><li></li><li><p><strong>ClassName</strong> ：类名字</p></li><li></li><li><p><strong>AutomationId</strong>： 控件AutomationId</p></li><li></li><li><p><strong>ControlType</strong> ：控件类型</p></li><li></li><li><p><strong>Depth</strong>：控件相对于searchFromControl的精确深度</p></li><li></li><li><p><strong>Compare</strong>：自定义比较函数function(control: Control, depth: int)-&gt;bool</p></li><li></li></ul><p><strong>searchDepth和Depth的区别：</strong></p><blockquote><p>searchDepth在指定的深度范围内（包括1<del>searchDepth层中的所有子孙控件）搜索第一个满足搜索条件的控件 Depth只在Depth所在的深度（如果Depth&gt;1，排除1</del>searchDepth-1层中的所有子孙控件）搜索第一个满足搜索条件的控件</p></blockquote><p>为了进一步操作该程序，我们可以使用inspect.exe工具或automation.py脚本分析控件结构。</p><p>通过inspect.exe工具分析控件时可以看到记事本的编辑区类型为DocumentControl：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_5.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20210921164143136"></p><p>但uiautomation实际使用该类型查找控件时却会找不到控件报错。</p><p>下面我们使用automation.py脚本来分析目标窗口，我的Python安装目录为D:\Miniconda3所以automation.py脚本会存在于D:\Miniconda3\Scripts\automation.py</p><p>查看帮助信息：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs applescript">&gt;python D:\Miniconda3\Scripts\automation.py -h<br>UIAutomation <span class="hljs-number">2.0</span><span class="hljs-number">.15</span> (Python <span class="hljs-number">3.7</span><span class="hljs-number">.4</span>, <span class="hljs-number">64</span> bit)<br>usage<br>-h      show command help<br>-t      <span class="hljs-built_in">delay</span> <span class="hljs-built_in">time</span>, default <span class="hljs-number">3</span> seconds, begin <span class="hljs-keyword">to</span> enumerate <span class="hljs-keyword">after</span> Value seconds, this must be an <span class="hljs-built_in">integer</span><br>        you can <span class="hljs-built_in">delay</span> a few seconds <span class="hljs-keyword">and</span> make a window active so automation can enumerate <span class="hljs-keyword">the</span> active window<br>-d      enumerate tree depth, this must be an <span class="hljs-built_in">integer</span>, <span class="hljs-keyword">if</span> <span class="hljs-keyword">it</span> <span class="hljs-keyword">is</span> null, enumerate <span class="hljs-keyword">the</span> whole tree<br>-r      enumerate <span class="hljs-keyword">from</span> root:Desktop window, <span class="hljs-keyword">if</span> <span class="hljs-keyword">it</span> <span class="hljs-keyword">is</span> null, enumerate <span class="hljs-keyword">from</span> foreground window<br>-f      enumerate <span class="hljs-keyword">from</span> focused control, <span class="hljs-keyword">if</span> <span class="hljs-keyword">it</span> <span class="hljs-keyword">is</span> null, enumerate <span class="hljs-keyword">from</span> foreground window<br>-c      enumerate <span class="hljs-keyword">the</span> control under cursor, <span class="hljs-keyword">if</span> depth <span class="hljs-keyword">is</span> &lt; <span class="hljs-number">0</span>, enumerate <span class="hljs-keyword">from</span> <span class="hljs-keyword">its</span> ancestor up <span class="hljs-keyword">to</span> depth<br>-a      show ancestors <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> control under cursor<br>-n      show control full <span class="hljs-built_in">name</span>, <span class="hljs-keyword">if</span> <span class="hljs-keyword">it</span> <span class="hljs-keyword">is</span> null, show <span class="hljs-keyword">first</span> <span class="hljs-number">30</span> <span class="hljs-built_in">characters</span> <span class="hljs-keyword">of</span> control&#x27;s <span class="hljs-built_in">name</span> <span class="hljs-keyword">in</span> console,<br>        always show full <span class="hljs-built_in">name</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">log</span> <span class="hljs-built_in">file</span> @AutomationLog.txt<br>-p      show process <span class="hljs-built_in">id</span> <span class="hljs-keyword">of</span> controls<br><br><span class="hljs-keyword">if</span> UnicodeError <span class="hljs-keyword">or</span> LookupError occurred when printing,<br><span class="hljs-keyword">try</span> <span class="hljs-keyword">to</span> change <span class="hljs-keyword">the</span> active code page <span class="hljs-keyword">of</span> console window <span class="hljs-keyword">by</span> using chcp <span class="hljs-keyword">or</span> see <span class="hljs-keyword">the</span> <span class="hljs-built_in">log</span> <span class="hljs-built_in">file</span> @AutomationLog.txt<br>chcp, <span class="hljs-keyword">get</span> current active code page<br>chcp <span class="hljs-number">936</span>, <span class="hljs-keyword">set</span> active code page <span class="hljs-keyword">to</span> gbk<br>chcp <span class="hljs-number">65001</span>, <span class="hljs-keyword">set</span> active code page <span class="hljs-keyword">to</span> utf<span class="hljs-number">-8</span><br><br>examples:<br>automation.py -t3<br>automation.py -t3 -r -d1 -m -n<br>automation.py -c -t3<br><span class="hljs-number">12345678910111213141516171819202122</span><br></code></pre></td></tr></table></figure><p>下面为了后续命令简化一点，我先将automation.py文件复制到cmd所在的当前目录。</p><p>执行以下命令：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">python</span> automation.<span class="hljs-keyword">py</span> -t1 -d1<br></code></pre></td></tr></table></figure><p>立马在1秒内将鼠标激活记事本窗口，可以看到控制台打印：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_6.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20210921170002665"></p><p>可以看到第一个控件的类型为EditControl。</p><p>下面将鼠标移动到记事本的编辑框内之后，执行：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">python</span> automation.<span class="hljs-keyword">py</span> -t0 -<span class="hljs-keyword">c</span><br></code></pre></td></tr></table></figure><p>就得到编辑器的全部子控件信息：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_7.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20210921170648813"></p><p>conda中注意激活 activate p38</p><p><img src="https://cdn.jsdelivr.net/gh/MuyanGit/pic_url@master/img/image-20220608153123108.png" srcset="/img/loading.gif" lazyload alt="image-20220608153123108"></p><p>下面我们使用uiautomation向记事本输入文本。</p><p>首先获取输入框：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">edit</span> <span class="hljs-operator">=</span> notepadWindow.EditControl()<br></code></pre></td></tr></table></figure><p><strong>方法1</strong>-使用EditControl支持的ValuePattern：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">edit<span class="hljs-selector-class">.GetValuePattern</span>()<span class="hljs-selector-class">.SetValue</span>(<span class="hljs-string">&#x27;方法1&#x27;</span>)<br></code></pre></td></tr></table></figure><p>该方法直接修改编辑框的文本内容。</p><p><strong>方法2</strong>-发送按键指令输入文本：</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;方法2&#x27;</span>)<br></code></pre></td></tr></table></figure><p>该方法的输入效果比较像打字机输入。</p><p><strong>方法3</strong>-复制文本后到剪切板粘贴：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">auto.<span class="hljs-constructor">SetClipboardText(<span class="hljs-string">&quot;方法3&quot;</span>)</span><br>edit.<span class="hljs-constructor">SendKeys(&#x27;&#123;Ctrl&#125;<span class="hljs-params">v</span>&#x27;)</span><br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>获取当前编辑框中的文本：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(edit.GetValuePattern()</span></span>.Value)<br></code></pre></td></tr></table></figure><p>最后我们点击标题栏的关闭按钮（可以通过索引或名称查找目标按钮）：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-comment"># 通过标题栏第三个按钮找到关闭按钮</span><br>notepadWindow.TitleBarControl<span class="hljs-params">(<span class="hljs-attr">Depth</span>=1)</span><span class="hljs-string">.ButtonControl</span><span class="hljs-params">(<span class="hljs-attr">foundIndex</span>=3)</span><span class="hljs-string">.Click</span><span class="hljs-params">()</span><br>1<br></code></pre></td></tr></table></figure><p>或：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-comment"># 通过标题栏查找名称为关闭的按钮</span><br>notepadWindow.TitleBarControl<span class="hljs-params">(<span class="hljs-attr">Depth</span>=1)</span><span class="hljs-string">.ButtonControl</span><span class="hljs-params">(<span class="hljs-attr">searchDepth</span>=1, <span class="hljs-attr">Name</span>=&#x27;关闭&#x27;)</span><span class="hljs-string">.Click</span><span class="hljs-params">()</span><br>1<br></code></pre></td></tr></table></figure><p>最后保存并关闭：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros">notepadWindow.TitleBarControl(<span class="hljs-attribute">Depth</span>=1).ButtonControl(searchDepth=1, <span class="hljs-attribute">Name</span>=<span class="hljs-string">&#x27;关闭&#x27;</span>).Click()<br><span class="hljs-comment"># 确认保存</span><br>auto.SendKeys(<span class="hljs-string">&#x27;&#123;ALT&#125;s&#x27;</span>)<br><span class="hljs-comment"># 输入文件名，并快捷键点击保存</span><br>auto.SendKeys(<span class="hljs-string">&#x27;自动保存&#123;ALT&#125;s&#x27;</span>)<br><span class="hljs-comment"># 如果弹出文件名冲突提示，则确认覆盖</span><br>auto.SendKeys(<span class="hljs-string">&#x27;&#123;ALT&#125;y&#x27;</span>)<br>123456<br></code></pre></td></tr></table></figure><p><strong>完整代码：</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs routeros">import subprocess<br>import uiautomation as auto<br><br>subprocess.Popen(<span class="hljs-string">&#x27;notepad.exe&#x27;</span>)<br><span class="hljs-comment"># 首先从桌面的第一层子控件中找到记事本程序的窗口WindowControl，再从这个窗口查找子控件</span><br>notepadWindow = auto.WindowControl(<span class="hljs-attribute">searchDepth</span>=1, <span class="hljs-attribute">ClassName</span>=<span class="hljs-string">&#x27;Notepad&#x27;</span>)<br><span class="hljs-built_in">print</span>(notepadWindow.Name)<br><span class="hljs-comment"># 设置窗口前置</span><br>notepadWindow.SetTopmost(<span class="hljs-literal">True</span>)<br><span class="hljs-comment"># 输入文本</span><br><span class="hljs-built_in">edit</span> = notepadWindow.EditControl()<br>auto.SetClipboardText(<span class="hljs-string">&quot;WIN98中的“98”是什么意思？&quot;</span>)<br>edit.SendKeys(<span class="hljs-string">&#x27;&#123;Ctrl&#125;v&#x27;</span>)<br><span class="hljs-comment"># 获取文本</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;编辑框内容：&quot;</span>,edit.GetValuePattern().Value)<br><span class="hljs-comment"># 通过标题栏查找名称为关闭的按钮</span><br>notepadWindow.TitleBarControl(<span class="hljs-attribute">Depth</span>=1).ButtonControl(searchDepth=1, <span class="hljs-attribute">Name</span>=<span class="hljs-string">&#x27;关闭&#x27;</span>).Click()<br><span class="hljs-comment"># 确认保存</span><br>auto.SendKeys(<span class="hljs-string">&#x27;&#123;ALT&#125;s&#x27;</span>)<br><span class="hljs-comment"># 输入文件名，并快捷键点击保存</span><br>auto.SendKeys(<span class="hljs-string">&#x27;自动保存&#123;ALT&#125;s&#x27;</span>)<br><span class="hljs-comment"># 如果弹出文件名冲突提示，则确认覆盖</span><br>auto.SendKeys(<span class="hljs-string">&#x27;&#123;ALT&#125;y&#x27;</span>)<br>123456789101112131415161718192021<br></code></pre></td></tr></table></figure><h2 id="控件延迟搜索机制"><a href="#控件延迟搜索机制" class="headerlink" title="控件延迟搜索机制"></a>控件延迟搜索机制</h2><p>底层COM对象方法：</p><blockquote><p>⚠️ Control.Element返回IUIAutomation底层COM对象IUIAutomationElement， 基本上Control的所有属性或方法都是通过调用IUIAutomationElement COM API和Win32 API实现的。</p></blockquote><p>延迟搜索控件：</p><blockquote><p>当我们创建一个Control对象时，uiautomation并不会马上开始搜索控件，而是当使用其属性或方法，并且内部的Control.Element是None时uiautomation才开始搜索控件。如果在uiautomation.TIME_OUT_SECOND(默认为10)秒内找不到控件，uiautomation就会抛出一个LookupError异常。</p></blockquote><p>也可以调用Control.Refind立马或重新开始搜索控件，例如：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">edit</span> = notepadWindow.EditControl()<br>edit.Refind()<br>1<br><span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure><p>但是当控件不存在时，则会报出错误。</p><p>为了避免函数最终抛出异常，可以调用Control.Exists(maxSearchSeconds, searchIntervalSeconds, printIfNotExist)检查目标控件是否存在：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">edit</span> = notepadWindow.EditControl()<br>edit.Exists()<br>1<br><span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure><blockquote><p>Control.Refind和Control.Exists均会使Control.Element无效并触发重新搜索逻辑。</p></blockquote><p>另一种检查目标控件是否存在的方法是auto.WaitForExist(control, timeout)。</p><p>下面继续以记事本为对象演示这个机制。首先打开第一个记事本并获取输入控件：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros">import subprocess<br>import uiautomation as auto<br>auto.uiautomation.SetGlobalSearchTimeout(2)  # 设置全局搜索超时时间为2秒<br><br>subprocess.Popen(<span class="hljs-string">&#x27;notepad.exe&#x27;</span>)<br>window = auto.WindowControl(<span class="hljs-attribute">searchDepth</span>=1, <span class="hljs-attribute">ClassName</span>=<span class="hljs-string">&#x27;Notepad&#x27;</span>)<br><span class="hljs-comment"># 创建控件对象时并不会开始搜索控件</span><br><span class="hljs-built_in">edit</span> = window.EditControl()<br>123456<br></code></pre></td></tr></table></figure><p>此时，控件window和edit还没有开始搜索，内部Control.Element的值为None。</p><p>第一次调用SendKeys时，才开始搜索控件window和edit：</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-meta"># 第一次调用SendKeys时, 才开始搜索控件window和edit</span><br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;第一次调用&#x27;</span>)<br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>搜索完毕后，才会开始执行发送按键方法，此时Control.Element有效。</p><p>第二次调用SendKeys不会触发搜索（Control.Element不为None）：</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;第二次调用&#x27;</span>)<br></code></pre></td></tr></table></figure><p>然后我们清空输入的内容，并关闭刚才打开的记事本：</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sas">edit.GetValuePatter<span class="hljs-meta">n</span>().SetValue(<span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-keyword">window</span>.GetWindowPatter<span class="hljs-meta">n</span>().<span class="hljs-meta">Close</span>()<br>1<br></code></pre></td></tr></table></figure><p>关闭后，此时虽然window和edit有值却已经无效了。</p><p>再次打开记事本，就必须重新搜索控件（否则无法操作新启动的窗口）：</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs axapta">subprocess.Popen(<span class="hljs-string">&#x27;notepad.exe&#x27;</span>)  <span class="hljs-meta"># 运行第二个Notepad</span><br>window.Refind()  <span class="hljs-meta"># 必须重新搜索</span><br><span class="hljs-keyword">edit</span>.Refind()  <span class="hljs-meta"># 必须重新搜索</span><br><span class="hljs-number">12</span><br></code></pre></td></tr></table></figure><p>然后可以将其关闭：</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sas"><span class="hljs-keyword">window</span>.GetWindowPatter<span class="hljs-meta">n</span>().<span class="hljs-meta">Close</span>()<br></code></pre></td></tr></table></figure><p>window和edit的Element再次失效。</p><p>Exists方法则既可以判断控件是否存在，也可以触发重新搜索：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">subprocess.<span class="hljs-constructor">Popen(&#x27;<span class="hljs-params">notepad</span>.<span class="hljs-params">exe</span>&#x27;)</span>  # 运行第三个Notepad<br><span class="hljs-keyword">if</span> window.<span class="hljs-constructor">Exists(<span class="hljs-params">maxSearchSeconds</span>=1.5, <span class="hljs-params">searchIntervalSeconds</span>=0.3)</span>:  # 触发重新搜索<br>    <span class="hljs-keyword">if</span> edit.<span class="hljs-constructor">Exists(<span class="hljs-params">maxSearchSeconds</span>=1.5)</span>:  # 触发重新搜索<br>        edit.<span class="hljs-constructor">SendKeys(&#x27;<span class="hljs-params">third</span> <span class="hljs-params">notepad</span>&#x27;)</span>  # 之前的Exists保证edit.Element有效<br>        edit.<span class="hljs-constructor">SendKeys(&#x27;&#123;Ctrl&#125;<span class="hljs-params">a</span>&#123;Del&#125;&#x27;)</span><br>    window.<span class="hljs-constructor">GetWindowPattern()</span>.<span class="hljs-constructor">Close()</span><br><span class="hljs-keyword">else</span>:<br>    print(<span class="hljs-string">&quot;窗口1.5秒内未找到&quot;</span>)<br><span class="hljs-number">1234567</span><br></code></pre></td></tr></table></figure><h2 id="示例：连续打开三个记事本并关闭"><a href="#示例：连续打开三个记事本并关闭" class="headerlink" title="示例：连续打开三个记事本并关闭"></a>示例：连续打开三个记事本并关闭</h2><p>完整代码与注释：</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs axapta">import subprocess<br>import uiautomation <span class="hljs-keyword">as</span> auto<br><span class="hljs-meta"># 设置全局搜索超时2秒</span><br>auto.uiautomation.SetGlobalSearchTimeout(<span class="hljs-number">2</span>)  <br><br>subprocess.Popen(<span class="hljs-string">&#x27;notepad.exe&#x27;</span>)<br>window = auto.WindowControl(searchDepth=<span class="hljs-number">1</span>, ClassName=<span class="hljs-string">&#x27;Notepad&#x27;</span>)<br>window.SetTopmost(True)<br><span class="hljs-keyword">edit</span> = window.EditControl()<br><span class="hljs-meta"># 当第一次调用SendKeys时, uiautomation开始在2秒内搜索控件window和edit</span><br><span class="hljs-meta"># 因为SendKeys内部会间接调用Control.Element并且Control.Element值是None</span><br><span class="hljs-meta"># 如果在15秒内找不到window和edit，会抛出LookupError异常</span><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;第一个记事本程序&#x27;</span>)<br>except LookupError <span class="hljs-keyword">as</span> ex:<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;第一个记事本窗口在2秒内未找到&quot;</span>)<br><br><span class="hljs-meta"># 第二次调用SendKeys不会触发搜索, 之前的调用保证Control.Element有效</span><br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;&#123;Ctrl&#125;a&#123;Del&#125;&#x27;</span>)<br><span class="hljs-meta"># 关闭第一个Notepad, window和edit的Element虽然有值，但是无效了</span><br>window.GetWindowPattern().Close()<br><br>subprocess.Popen(<span class="hljs-string">&#x27;notepad.exe&#x27;</span>)  <span class="hljs-meta"># 运行第二个Notepad</span><br>window.Refind()  <span class="hljs-meta"># 必须重新搜索</span><br><span class="hljs-keyword">edit</span>.Refind()  <span class="hljs-meta"># 必须重新搜索</span><br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;第二个记事本程序&#x27;</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;&#123;Ctrl&#125;a&#123;Del&#125;&#x27;</span>)<br>window.GetWindowPattern().Close()  <span class="hljs-meta"># 关闭第二个Notepad, window和edit的Element虽然有值，但是再次无效了</span><br><br>subprocess.Popen(<span class="hljs-string">&#x27;notepad.exe&#x27;</span>)  <span class="hljs-meta"># 运行第三个Notepad</span><br><span class="hljs-keyword">if</span> window.Exists(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>):  <span class="hljs-meta"># 触发重新搜索</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">edit</span>.Exists(<span class="hljs-number">3</span>):  <span class="hljs-meta"># 触发重新搜索</span><br>        <span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;第三个记事本程序&#x27;</span>)  <span class="hljs-meta"># 之前的Exists保证edit.Element有效</span><br>        <span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;&#123;Ctrl&#125;a&#123;Del&#125;&#x27;</span>)<br>    window.GetWindowPattern().Close()<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;第三个记事本程序在三秒内不存在&quot;</span>)<br><span class="hljs-number">1234567891011121314151617181920212223242526272829303132</span><br></code></pre></td></tr></table></figure><h1 id="UIAutomation的常见功能"><a href="#UIAutomation的常见功能" class="headerlink" title="UIAutomation的常见功能"></a>UIAutomation的常见功能</h1><p>导包：</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-keyword">import</span> uiautomation <span class="hljs-keyword">as</span> auto<br></code></pre></td></tr></table></figure><h2 id="基本方法"><a href="#基本方法" class="headerlink" title="基本方法"></a>基本方法</h2><p><strong>显示桌面（相当于点击桌面右下角的按钮）：</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">auto<span class="hljs-selector-class">.ShowDesktop</span>()<br></code></pre></td></tr></table></figure><p><strong>获取uiautomation已运行的时间：</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">auto<span class="hljs-selector-class">.ProcessTime</span>()<br></code></pre></td></tr></table></figure><p><strong>判断两个控件是否一致：</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">auto.<span class="hljs-constructor">ControlsAreSame(<span class="hljs-params">control1</span>, <span class="hljs-params">control2</span>)</span><br></code></pre></td></tr></table></figure><p><strong>鼠标点击指定坐标：</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">auto.<span class="hljs-constructor">Click(<span class="hljs-params">x</span>, <span class="hljs-params">y</span>)</span><br></code></pre></td></tr></table></figure><p><strong>右键单击：</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">auto.<span class="hljs-constructor">RightClick(<span class="hljs-params">x</span>, <span class="hljs-params">y</span>)</span><br></code></pre></td></tr></table></figure><p><strong>鼠标拖拽(鼠标从(x1,y1)位置按下鼠标拖动到(x2,y2)位置)：</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">auto.<span class="hljs-constructor">DragDrop(<span class="hljs-params">x1</span>, <span class="hljs-params">y1</span>, <span class="hljs-params">x2</span>, <span class="hljs-params">y2</span>, <span class="hljs-params">moveSpeed</span>=1)</span><br></code></pre></td></tr></table></figure><p>moveSpeed参数决定了移动的速度。</p><p>关于鼠标滚轮操作详见后面的实例，被找到的控件调用鼠标点击方法不需要传入坐标。</p><h2 id="获取窗口对象"><a href="#获取窗口对象" class="headerlink" title="获取窗口对象"></a>获取窗口对象</h2><p>获取桌面对象：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">c</span> <span class="hljs-operator">=</span> auto.GetRootControl()<br></code></pre></td></tr></table></figure><p>返回运行当前python程序的控制台窗口对象：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">cmdWindow</span> <span class="hljs-operator">=</span> auto.GetConsoleWindow()<br></code></pre></td></tr></table></figure><blockquote><p>没有找到则返回None。</p></blockquote><p>获取当前鼠标位置对应的窗口：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">c</span> <span class="hljs-operator">=</span> auto.ControlFromCursor().GetTopLevelControl()<br></code></pre></td></tr></table></figure><blockquote><p>ControlFromCursor返回了当前鼠标位置的控件，GetTopLevelControl获取了该控件对应的顶级窗口对象。</p></blockquote><p>获取当前激活窗口对应的对象：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">c</span> <span class="hljs-operator">=</span> auto.GetForegroundControl().GetTopLevelControl()<br></code></pre></td></tr></table></figure><h2 id="控件查找方法"><a href="#控件查找方法" class="headerlink" title="控件查找方法"></a>控件查找方法</h2><p>获取所有的子控件：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lsl"><span class="hljs-section">control</span>.GetChildren()<br></code></pre></td></tr></table></figure><p>获取首个子控件：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lsl"><span class="hljs-section">control</span>.GetFirstChildControl()<br></code></pre></td></tr></table></figure><p>获取最后一个子控件：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lsl"><span class="hljs-section">control</span>.GetLastChildControl()<br></code></pre></td></tr></table></figure><p>获取下一个兄弟控件：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lsl"><span class="hljs-section">control</span>.GetNextSiblingControl()<br></code></pre></td></tr></table></figure><p>获取前一个兄弟控件：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lsl"><span class="hljs-section">control</span>.GetPreviousSiblingControl()<br></code></pre></td></tr></table></figure><p>获取父控件：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lsl"><span class="hljs-section">control</span>.GetParentControl()<br></code></pre></td></tr></table></figure><p>获取顶层窗口控件：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lsl"><span class="hljs-section">control</span>.GetTopLevelControl()<br></code></pre></td></tr></table></figure><p>获取满足指定条件的祖先控件：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">control.<span class="hljs-constructor">GetAncestorControl(<span class="hljs-params">func</span>)</span><br></code></pre></td></tr></table></figure><p>传入的函数参数要求：function(control: Control, depth: int) -&gt; bool</p><p>当函数返回True时表示找到控件并返回，例如以下方法几乎可以得与GetTopLevelControl()相同的结果：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">control.<span class="hljs-constructor">GetAncestorControl(<span class="hljs-params">lambda</span> <span class="hljs-params">c</span>, <span class="hljs-params">d</span>: <span class="hljs-params">isinstance</span>(<span class="hljs-params">c</span>, <span class="hljs-params">auto</span>.WindowControl)</span>)<br></code></pre></td></tr></table></figure><h2 id="窗口属性调整"><a href="#窗口属性调整" class="headerlink" title="窗口属性调整"></a>窗口属性调整</h2><p><strong>假设获取到一个窗口对象：</strong></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">win</span> <span class="hljs-operator">=</span> auto.ControlFromCursor().GetTopLevelControl()<br></code></pre></td></tr></table></figure><p><strong>获取本地窗口句柄：</strong></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">win</span>.NativeWindowHandle<br></code></pre></td></tr></table></figure><p><strong>根据本地窗口句柄获取窗口控件对象：</strong></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">win2</span> <span class="hljs-operator">=</span> auto.ControlFromHandle(win.NativeWindowHandle)<br></code></pre></td></tr></table></figure><p>经测试，对象一致：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">auto.<span class="hljs-constructor">ControlsAreSame(<span class="hljs-params">win</span>, <span class="hljs-params">win2</span>)</span><br>True<br></code></pre></td></tr></table></figure><p><strong>隐藏窗口：</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">win</span>.Hide(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><p><strong>显示窗口：</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">win</span>.Show(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><p><strong>窗口最小化：</strong></p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">win</span><span class="hljs-operator">.</span><span class="hljs-built_in">Minimize</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><strong>窗口最大化：</strong></p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">win</span><span class="hljs-operator">.</span><span class="hljs-built_in">Maximize</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p><strong>判断窗口是否已经被最小化：</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">auto.<span class="hljs-constructor">IsIconic(<span class="hljs-params">win</span>.NativeWindowHandle)</span><br></code></pre></td></tr></table></figure><blockquote><p>IsIconic进支持传入本地窗口句柄。</p></blockquote><p><strong>将最小化的窗口的恢复显示：</strong></p><p><strong>修改窗口的位置和大小</strong>，例如将某个窗口调整到最后一个屏幕的一半：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">rects = auto<span class="hljs-selector-class">.GetMonitorsRect</span>()<br>rect = rects<span class="hljs-selector-attr">[-1]</span><br>win<span class="hljs-selector-class">.MoveWindow</span>(rect<span class="hljs-selector-class">.left</span>, rect<span class="hljs-selector-class">.top</span>,<br>               rect<span class="hljs-selector-class">.width</span>()<span class="hljs-comment">//2, rect.height()-30)</span><br><span class="hljs-number">123</span><br></code></pre></td></tr></table></figure><p>不过这种调整方法对于cmd这种命令行窗口无效，只能在获取其TransformPattern对象后，调用<strong>Move</strong>和<strong>Resize</strong>方法来实现。上面的MoveWindow等价于：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">transform_win = win.<span class="hljs-constructor">GetTransformPattern()</span><br>transform_win.<span class="hljs-constructor">Move(<span class="hljs-params">rect</span>.<span class="hljs-params">left</span>, <span class="hljs-params">rect</span>.<span class="hljs-params">top</span>)</span><br>transform_win.<span class="hljs-constructor">Resize(<span class="hljs-params">rect</span>.<span class="hljs-params">width</span>()</span><span class="hljs-comment">//2, rect.height()-30)</span><br><span class="hljs-number">12</span><br></code></pre></td></tr></table></figure><p><strong>移动窗口到屏幕中心位置：</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">win.<span class="hljs-constructor">MoveToCenter()</span><br></code></pre></td></tr></table></figure><p><strong>窗口置顶：</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">window</span>.SetTopmost(<span class="hljs-keyword">True</span>)<br></code></pre></td></tr></table></figure><p><strong>获取窗口标题并修改窗口标题：</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">win.<span class="hljs-constructor">SetWindowText(<span class="hljs-params">win</span>.GetWindowText()</span>+<span class="hljs-string">&quot;|小小明&quot;</span>)<br></code></pre></td></tr></table></figure><p><strong>获取运行当前python程序控制台窗口的标题：</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss">auto<span class="hljs-selector-class">.GetConsoleTitle</span>()<br># auto<span class="hljs-selector-class">.GetConsoleOriginalTitle</span>()<br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p><strong>设置运行当前python程序控制台窗口的标题：</strong></p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-literal">auto</span>.SetConsoleTitle(<span class="hljs-string">&#x27;自定义控制台标题&#x27;</span>)<br></code></pre></td></tr></table></figure><h2 id="WalkTree遍历子控件"><a href="#WalkTree遍历子控件" class="headerlink" title="WalkTree遍历子控件"></a>WalkTree遍历子控件</h2><p>除了auto.WalkTree遍历目标控件外，还有auto.WalkControl遍历控件，区别在于auto.WalkTree必须传入自定义函数指定遍历的行为。auto.WalkControl将会在后面涉及可折叠类型的控件遍历时进行演示，下面给出一个简单的通过WalkTree遍历桌面的示例：</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs mel">import uiautomation as auto<br><br><br>def GetFirstChild(<span class="hljs-keyword">control</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">control</span>.GetFirstChildControl()<br><br><br>def GetNextSibling(<span class="hljs-keyword">control</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">control</span>.GetNextSiblingControl()<br><br><br>desktop = auto.GetRootControl()<br><span class="hljs-keyword">for</span> <span class="hljs-keyword">control</span>, depth <span class="hljs-keyword">in</span> auto.WalkTree(desktop, getFirstChild=GetFirstChild, getNextSibling=GetNextSibling,<br>                                    includeTop=True, maxDepth=<span class="hljs-number">2</span>):<br>    <span class="hljs-keyword">if</span> not <span class="hljs-keyword">control</span>.Name:<br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27; &#x27;</span> * depth * <span class="hljs-number">4</span>, <span class="hljs-keyword">control</span>.Name)<br><span class="hljs-number">12345678910</span><br></code></pre></td></tr></table></figure><p>maxDepth指定了遍历深度，除了指定这两个方法以外还可以只转入getChildren方法：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs routeros">def GetChildren(control):<br>    return control.GetChildren()<br><br><br><span class="hljs-keyword">for</span> control, depth, remain <span class="hljs-keyword">in</span> auto.WalkTree(desktop,<br>                                            <span class="hljs-attribute">getChildren</span>=GetChildren,<br>                                            <span class="hljs-attribute">includeTop</span>=<span class="hljs-literal">True</span>,<br>                                            <span class="hljs-attribute">maxDepth</span>=2):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> control.Name:<br>        continue<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27; &#x27;</span> * depth * 4, control.Name)<br>12345678<br></code></pre></td></tr></table></figure><p>结果过滤的方逻辑我们还可以写到yieldCondition的传入函数中：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs routeros">def yieldCondition(control, depth):<br>    <span class="hljs-keyword">if</span> control.Name:<br>        return <span class="hljs-literal">True</span><br><br><br><span class="hljs-keyword">for</span> control, depth, remain <span class="hljs-keyword">in</span> auto.WalkTree(desktop,<br>                                            <span class="hljs-attribute">getChildren</span>=GetChildren,<br>                                            <span class="hljs-attribute">yieldCondition</span>=yieldCondition,<br>                                            <span class="hljs-attribute">includeTop</span>=<span class="hljs-literal">True</span>,<br>                                            <span class="hljs-attribute">maxDepth</span>=2):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27; &#x27;</span> * depth * 4, control.Name)<br>12345678<br></code></pre></td></tr></table></figure><p>在我电脑当前执行结果均为：</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs stata">桌面 1<br>     任务栏<br>         开始<br>         在这里输入你要搜索的内容<br>         开始<br>         在这里输入你要搜索的内容<br>         系统时钟, 23:02, ‎2021/‎11/‎15<br>     <span class="hljs-keyword">test</span> - Jupyter Notebook - 360安全浏览器 13.1<br>         Chrome Legacy <span class="hljs-keyword">Window</span><br>     一文掌握uiautomation的经典案例.md• - Typora<br>         Typora<br>     UIAutomation_demos – clipboard_test.py PyCharm<br>     <span class="hljs-keyword">Program</span> Manager<br>123456789101112<br></code></pre></td></tr></table></figure><p>WalkTree的规则是当设置getChildren函数时，忽略getFirstChild和getNextSibling，否则使用这两个函数。设置yieldCondition函数时则开启额外的过滤。</p><p>甚至可以<strong>使用WalkTree方法计算全排列问题：</strong></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs vim">def NextPermutations(aTuple):<br>    <span class="hljs-keyword">left</span>, permutation = aTuple<br>    <span class="hljs-keyword">ret</span> = []<br>    <span class="hljs-keyword">for</span> i, item in enumerate(<span class="hljs-keyword">left</span>):<br>        nextLeft = <span class="hljs-keyword">left</span>[:]<br>        del nextLeft[i]<br>        nextPermutation = permutation + [item]<br>        <span class="hljs-keyword">ret</span>.<span class="hljs-keyword">append</span>((nextLeft, nextPermutation))<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">ret</span><br><br><br>uniqueItems = <span class="hljs-keyword">list</span>(<span class="hljs-string">&quot;abc&quot;</span>)<br>n = <span class="hljs-built_in">len</span>(uniqueItems)<br><span class="hljs-built_in">count</span> = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">left</span>, permutation), depth, remain in auto.WalkTree((uniqueItems, []), NextPermutations,<br>                                                        yieldCondition=lambda <span class="hljs-keyword">c</span>, d: d == n):<br>    <span class="hljs-built_in">count</span> += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">print</span>(<span class="hljs-built_in">count</span>, permutation)<br><span class="hljs-number">123456789101112131415</span><br><span class="hljs-number">1</span> [<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>]<br><span class="hljs-number">2</span> [<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>]<br><span class="hljs-number">3</span> [<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>]<br><span class="hljs-number">4</span> [<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>]<br><span class="hljs-number">5</span> [<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>]<br><span class="hljs-number">6</span> [<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>]<br><span class="hljs-number">12345</span><br></code></pre></td></tr></table></figure><p>可以看到已经顺利的计算出正确的结果。</p><h2 id="Bitmap位图对象的使用"><a href="#Bitmap位图对象的使用" class="headerlink" title="Bitmap位图对象的使用"></a>Bitmap位图对象的使用</h2><p>默认新建的图片为空白透明图片：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arduino">width, height = <span class="hljs-number">500</span>, <span class="hljs-number">500</span><br># 创建一张透明图片<br>bitmap = <span class="hljs-keyword">auto</span>.<span class="hljs-built_in">Bitmap</span>(width, height)<br><span class="hljs-number">12</span><br></code></pre></td></tr></table></figure><p>然后我们可以设置一点颜色，首先以逐像素遍历的方式操作：</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs maxima"><span class="hljs-built_in">width</span>, <span class="hljs-built_in">height</span> = <span class="hljs-number">500</span>, <span class="hljs-number">500</span><br># 创建一张透明图片<br>bitmap = auto.Bitmap(<span class="hljs-built_in">width</span>, <span class="hljs-built_in">height</span>)<br>start = auto.ProcessTime()<br><span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">width</span>):<br>    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">height</span>):<br>        <span class="hljs-built_in">color</span> = ((x-<span class="hljs-built_in">width</span>)**<span class="hljs-number">2</span>+(y-<span class="hljs-built_in">height</span>)**<span class="hljs-number">2</span>)*<span class="hljs-number">255</span>//(<span class="hljs-built_in">width</span>**<span class="hljs-number">2</span>+<span class="hljs-built_in">height</span>**<span class="hljs-number">2</span>)<br>        bitmap.SetPixelColor(x, y, <span class="hljs-number">0xFF00FF</span> | <span class="hljs-built_in">color</span> &lt;&lt; <span class="hljs-number">24</span>)<br>cost = auto.ProcessTime() - start<br><span class="hljs-built_in">print</span>(f&#x27;SetPixelColor 逐像素设置 &#123;<span class="hljs-built_in">width</span>&#125;x&#123;<span class="hljs-built_in">height</span>&#125; 图片的颜色耗时 &#123;cost:.3f&#125;s&#x27;)<br>bitmap.ToFile(&#x27;tmp.png&#x27;)<br><span class="hljs-number">12345678910</span><br>SetPixelColor 逐像素设置 500x500 图片的颜色耗时 <span class="hljs-number">0.</span>648s<br></code></pre></td></tr></table></figure><p>上述代码遍历每个像素点，通过SetPixelColor方法设置颜色。可以看到耗时达到0.6秒以上，能否快一点呢？</p><p>SetPixelColorsOfRect方法可以直接设置整个区域的颜色：</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs maxima">start = auto.ProcessTime()<br>colors = []<br><span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">width</span>):<br>    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">height</span>):<br>        <span class="hljs-built_in">color</span> = ((x-<span class="hljs-built_in">width</span>)**<span class="hljs-number">2</span>+(y-<span class="hljs-built_in">height</span>)**<span class="hljs-number">2</span>)*<span class="hljs-number">255</span>//(<span class="hljs-built_in">width</span>**<span class="hljs-number">2</span>+<span class="hljs-built_in">height</span>**<span class="hljs-number">2</span>)<br>        colors.<span class="hljs-built_in">append</span>(<span class="hljs-number">0xFF00FF</span> | <span class="hljs-built_in">color</span> &lt;&lt; <span class="hljs-number">24</span>)<br>bitmap.SetPixelColorsOfRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">width</span>, <span class="hljs-built_in">height</span>, colors)<br>cost = auto.ProcessTime() - start<br><span class="hljs-built_in">print</span>(f&#x27;SetPixelColorsOfRect 设置 &#123;<span class="hljs-built_in">width</span>&#125;x&#123;<span class="hljs-built_in">height</span>&#125; 图片矩形区域的颜色，耗时 &#123;cost:.3f&#125;s&#x27;)<br>bitmap.ToFile(&#x27;tmp.png&#x27;)<br><span class="hljs-number">123456789</span><br>SetPixelColorsOfRect 设置 500x500 图片矩形区域的颜色，耗时 <span class="hljs-number">0.</span>460s<br></code></pre></td></tr></table></figure><p>显然设置整个区域的颜色会更快一些。</p><p>经测试使用GetPixelColor方法获取到的颜色值可能会因为负数补码导致获取到的值与当初设置的不一致。我们可以通过GetAllPixelColors方法获取原生数组后，然后计算偏移量获取颜色值：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">colors = bitmap.<span class="hljs-constructor">GetAllPixelColors()</span><br><br><br>def get<span class="hljs-constructor">PixelColor(<span class="hljs-params">x</span>, <span class="hljs-params">y</span>)</span>:<br>    return colors<span class="hljs-literal">[<span class="hljs-identifier">x</span><span class="hljs-operator">*</span><span class="hljs-identifier">width</span>+<span class="hljs-identifier">y</span>]</span><br>    <br>get<span class="hljs-constructor">PixelColor(10, 10)</span><br><span class="hljs-number">1234</span><br><span class="hljs-number">4110352639</span><br></code></pre></td></tr></table></figure><p>可以通过控件的ToBitmap方法对该控件截图获取Bitmap对象，传入参数可以决定截取的范围，例如我们截图桌面范围480*360范围内（不传参则获取整个控件）的图片：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">root = auto<span class="hljs-selector-class">.GetRootControl</span>()<br>bitmap = root<span class="hljs-selector-class">.ToBitmap</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">480</span>, <span class="hljs-number">360</span>)<br>bitmap<span class="hljs-selector-class">.ToFile</span>(<span class="hljs-string">&#x27;tmp.png&#x27;</span>)<br><span class="hljs-function"><span class="hljs-title">Image</span><span class="hljs-params">(<span class="hljs-string">&quot;tmp.png&quot;</span>)</span></span><br><span class="hljs-number">123</span><br></code></pre></td></tr></table></figure><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_8.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211115214149137"></p><p>ToBitmap方法也可以使用Bitmap.FromControl方法替代：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">bitmap = auto.Bitmap.<span class="hljs-constructor">FromControl(<span class="hljs-params">control</span>, <span class="hljs-params">x</span>, <span class="hljs-params">y</span>, <span class="hljs-params">width</span>, <span class="hljs-params">height</span>)</span><br></code></pre></td></tr></table></figure><p><strong>裁切图片：</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">with</span> bitmap.<span class="hljs-constructor">Copy(150, 100, 80, 102)</span> <span class="hljs-keyword">as</span> subBitmap:<br>    subBitmap.<span class="hljs-constructor">ToFile(&#x27;<span class="hljs-params">tmp</span>.<span class="hljs-params">png</span>&#x27;)</span><br>    display(<span class="hljs-constructor">Image(<span class="hljs-string">&quot;tmp.png&quot;</span>)</span>)<br><span class="hljs-number">12</span><br></code></pre></td></tr></table></figure><p>结果：成功裁切出 极速PDF阅读器 的图标。</p><p>若需要<strong>同时裁切多个部分</strong>，可以使用GetPixelColorsOfRects方法：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">width, height = <span class="hljs-number">75</span>, <span class="hljs-number">85</span><br>rects = <span class="hljs-literal">[((<span class="hljs-identifier">width</span><span class="hljs-operator">*</span><span class="hljs-identifier">i</span>, <span class="hljs-number">0</span>, <span class="hljs-identifier">width</span>, <span class="hljs-identifier">height</span>)) <span class="hljs-identifier">for</span> <span class="hljs-identifier">i</span> <span class="hljs-identifier">in</span> <span class="hljs-identifier">range</span>(<span class="hljs-number">3</span>)]</span><br>colors = bitmap.<span class="hljs-constructor">GetPixelColorsOfRects(<span class="hljs-params">rects</span>)</span><br><span class="hljs-keyword">for</span> nativeArray <span class="hljs-keyword">in</span> colors:<br>    <span class="hljs-keyword">with</span> auto.<span class="hljs-constructor">Bitmap(<span class="hljs-params">width</span>, <span class="hljs-params">height</span>)</span> <span class="hljs-keyword">as</span> subBitmap:<br>        subBitmap.<span class="hljs-constructor">SetPixelColorsOfRect(0, 0, <span class="hljs-params">width</span>, <span class="hljs-params">height</span>, <span class="hljs-params">nativeArray</span>)</span><br>        subBitmap.<span class="hljs-constructor">ToFile(&#x27;<span class="hljs-params">tmp</span>.<span class="hljs-params">png</span>&#x27;)</span><br>        display(<span class="hljs-constructor">Image(<span class="hljs-string">&quot;tmp.png&quot;</span>)</span>)<br><span class="hljs-number">1234567</span><br></code></pre></td></tr></table></figure><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_9.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211115215855714"></p><p><strong>X轴翻转：</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">with</span> bitmap.<span class="hljs-constructor">RotateFlip(<span class="hljs-params">auto</span>.RotateFlipType.RotateNoneFlipX)</span> <span class="hljs-keyword">as</span> bmp:<br>        bmp.<span class="hljs-constructor">ToFile(&#x27;<span class="hljs-params">tmp</span>.<span class="hljs-params">png</span>&#x27;)</span><br>        display(<span class="hljs-constructor">Image(<span class="hljs-string">&quot;tmp.png&quot;</span>)</span>)<br><span class="hljs-number">12</span><br></code></pre></td></tr></table></figure><p><strong>Y轴翻转：</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">with</span> bitmap.<span class="hljs-constructor">RotateFlip(<span class="hljs-params">auto</span>.RotateFlipType.RotateNoneFlipY)</span> <span class="hljs-keyword">as</span> bmp:<br>    bmp.<span class="hljs-constructor">ToFile(&#x27;<span class="hljs-params">tmp</span>.<span class="hljs-params">png</span>&#x27;)</span><br>    display(<span class="hljs-constructor">Image(<span class="hljs-string">&quot;tmp.png&quot;</span>)</span>)<br><span class="hljs-number">12</span><br></code></pre></td></tr></table></figure><p><strong>90度旋转：</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">with</span> bitmap.<span class="hljs-constructor">Rotate(90)</span> <span class="hljs-keyword">as</span> bmp:<br>    bmp.<span class="hljs-constructor">ToFile(&#x27;<span class="hljs-params">tmp</span>.<span class="hljs-params">png</span>&#x27;)</span><br>    display(<span class="hljs-constructor">Image(<span class="hljs-string">&quot;tmp.png&quot;</span>)</span>)<br><span class="hljs-number">12</span><br></code></pre></td></tr></table></figure><p><strong>30度旋转（非90度整数倍 旋转）</strong>：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">with</span> bitmap.<span class="hljs-constructor">Rotate(30)</span> <span class="hljs-keyword">as</span> bmp:<br>    bmp.<span class="hljs-constructor">ToFile(&#x27;<span class="hljs-params">tmp</span>.<span class="hljs-params">png</span>&#x27;)</span><br>    display(<span class="hljs-constructor">Image(<span class="hljs-string">&quot;tmp.png&quot;</span>)</span>)<br><span class="hljs-number">12</span><br></code></pre></td></tr></table></figure><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_10.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211115220338272"></p><h2 id="对多个显示器分别截屏"><a href="#对多个显示器分别截屏" class="headerlink" title="对多个显示器分别截屏"></a>对多个显示器分别截屏</h2><p>结合前面的方法，我们可以对桌面截屏，对鼠标下的控件截屏，对当前激活窗口截屏等等。</p><p>基本都是在获取相应控件后调用如下方法：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">control.<span class="hljs-constructor">CaptureToImage(<span class="hljs-params">savePath</span>)</span><br></code></pre></td></tr></table></figure><p>获取桌面控件前面已经演示，下面看看如何同时获取多个屏幕的截图：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">c = auto<span class="hljs-selector-class">.GetRootControl</span>()<br>rects = auto<span class="hljs-selector-class">.GetMonitorsRect</span>()<br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(rects)</span></span><br><span class="hljs-keyword">for</span> rect <span class="hljs-keyword">in</span> rects:<br>    c<span class="hljs-selector-class">.CaptureToImage</span>(<span class="hljs-string">&#x27;tmp.png&#x27;</span>, rect<span class="hljs-selector-class">.left</span>, rect<span class="hljs-selector-class">.top</span>,<br>                     rect<span class="hljs-selector-class">.width</span>(), rect<span class="hljs-selector-class">.height</span>())<br>    <span class="hljs-attribute">display</span>(<span class="hljs-built_in">Image</span>(<span class="hljs-string">&quot;tmp.png&quot;</span>))<br><span class="hljs-number">123456</span><br></code></pre></td></tr></table></figure><p>核心点就是通过GetMonitorsRect获取所有屏幕的坐标范围数组，截图时指定坐标范围即可。</p><h2 id="剪切板操作"><a href="#剪切板操作" class="headerlink" title="剪切板操作"></a>剪切板操作</h2><p>通常我们会使用pyperclip对文本进行复制粘贴，但实际上uiautomation所支持的剪切板操作会更加丰富，不仅支持纯文本，还支持富文本和图片。</p><p>涉及文件的剪切板操作，个人已经在**<a target="_blank" rel="noopener" href="https://blog.csdn.net/as604049322/article/details/120631425">《UI自动化控制微信发送文件》</a>**一文中实现将文件设置到剪切板中。</p><p>获取当前剪切板的内容格式：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">import uiautomation as auto<br><br>formats = auto<span class="hljs-selector-class">.GetClipboardFormats</span>()<br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(formats)</span></span><br><span class="hljs-number">12</span><br>&#123;<span class="hljs-number">49282</span>: <span class="hljs-string">&#x27;HTML Format&#x27;</span>, <span class="hljs-number">49402</span>: <span class="hljs-string">&#x27;Rich Text Format&#x27;</span>, <span class="hljs-number">13</span>: <span class="hljs-string">&#x27;CF_UNICODETEXT&#x27;</span>, <span class="hljs-number">1</span>: <span class="hljs-string">&#x27;CF_TEXT&#x27;</span>, <span class="hljs-number">49287</span>: <span class="hljs-string">&#x27;UniformResourceLocator&#x27;</span>, <span class="hljs-number">50062</span>: <span class="hljs-string">&#x27;JAVA_DATAFLAVOR:application/x-java-jvm-local-objectref; class=c&#x27;</span>, <span class="hljs-number">16</span>: <span class="hljs-string">&#x27;CF_LOCALE&#x27;</span>, <span class="hljs-number">7</span>: <span class="hljs-string">&#x27;CF_OEMTEXT&#x27;</span>&#125;<br></code></pre></td></tr></table></figure><p>读取剪切板时，我们可以根据当前剪切板的格式分别作不同的处理：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stylus">formats = auto<span class="hljs-selector-class">.GetClipboardFormats</span>()<br><span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> formats<span class="hljs-selector-class">.items</span>():<br>    <span class="hljs-keyword">if</span> k == auto<span class="hljs-selector-class">.ClipboardFormat</span><span class="hljs-selector-class">.CF_UNICODETEXT</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;文本格式：&quot;</span>, auto<span class="hljs-selector-class">.GetClipboardText</span>())<br>    elif k == auto<span class="hljs-selector-class">.ClipboardFormat</span><span class="hljs-selector-class">.CF_HTML</span>:<br>        htmlText = auto<span class="hljs-selector-class">.GetClipboardHtml</span>()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;富文本格式：&quot;</span>, htmlText)<br>    elif k == auto<span class="hljs-selector-class">.ClipboardFormat</span><span class="hljs-selector-class">.CF_BITMAP</span>:<br>        bmp = auto<span class="hljs-selector-class">.GetClipboardBitmap</span>()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;位图：&quot;</span>, bmp)<br><span class="hljs-number">123456789</span><br></code></pre></td></tr></table></figure><p>不过更关键的是设置数据到剪切板。</p><p><strong>设置文本到剪切板：</strong></p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-literal">auto</span>.SetClipboardText(<span class="hljs-string">&#x27;Hello World&#x27;</span>)<br></code></pre></td></tr></table></figure><p><strong>设置富文本到剪切板：</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">auto.<span class="hljs-constructor">SetClipboardHtml(&#x27;&lt;<span class="hljs-params">h1</span>&gt;Title&lt;<span class="hljs-operator">/</span><span class="hljs-params">h1</span>&gt;&lt;<span class="hljs-params">br</span>&gt;&lt;<span class="hljs-params">h3</span>&gt;Hello&lt;<span class="hljs-operator">/</span><span class="hljs-params">h3</span>&gt;&lt;<span class="hljs-params">br</span>&gt;&lt;<span class="hljs-params">p</span>&gt;<span class="hljs-params">test</span> <span class="hljs-params">html</span>&lt;<span class="hljs-operator">/</span><span class="hljs-params">p</span>&gt;&lt;<span class="hljs-params">br</span>&gt;&#x27;)</span><br></code></pre></td></tr></table></figure><p><strong>设置图片到剪切板</strong>，只需要将Bitmap设置到剪切板即可，下面演示通过图片文件路径构造Bitmap并设置到剪切板：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">with</span> auto.Bitmap.<span class="hljs-constructor">FromFile(<span class="hljs-params">path</span>)</span> <span class="hljs-keyword">as</span> bmp:<br>    auto.<span class="hljs-constructor">SetClipboardBitmap(<span class="hljs-params">bmp</span>)</span><br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>而根据文件路径设置文件到剪切板已通过win32clipboard实现，详见：**<a target="_blank" rel="noopener" href="https://blog.csdn.net/as604049322/article/details/120631425">《UI自动化控制微信发送文件》</a>**一文。</p><h2 id="自带的Logger日志输出类"><a href="#自带的Logger日志输出类" class="headerlink" title="自带的Logger日志输出类"></a>自带的Logger日志输出类</h2><p>uiautomation自带了日志输出类，有时我们希望输出不仅到控制台，同时输出到文件时，可以直接使用uiautomation自带的方法。</p><p>基础输出：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">auto.Logger.<span class="hljs-keyword">Write</span>(<br>    <span class="hljs-keyword">log</span>: <span class="hljs-keyword">Any</span>,<br>    consoleColor: <span class="hljs-type">int</span> = <span class="hljs-number">-1</span>,<br>    writeToFile: <span class="hljs-type">bool</span> = <span class="hljs-keyword">True</span>,<br>    printToStdout: <span class="hljs-type">bool</span> = <span class="hljs-keyword">True</span>,<br>    logFile: str = <span class="hljs-keyword">None</span>,<br>    printTruncateLen: <span class="hljs-type">int</span> = <span class="hljs-number">0</span>,<br>)<br><span class="hljs-number">1234567</span><br></code></pre></td></tr></table></figure><p>-</p><ul><li><p>log: 要输出的日志内容</p></li><li></li><li><p>consoleColor: 文本在控制台输出的颜色</p></li><li></li><li><p>writeToFile: 是否输出到文件，默认为True</p></li><li></li><li><p>printToStdout: 是否输出到控制台，默认为True</p></li><li></li><li><p>logFile: 日志文件所在位置，默认为当前目录下的@AutomationLog.txt文件</p></li><li></li><li><p>printTruncateLen: 日志截断大小，每条输出超过长度限制时在控制台的输出会被截断。设置该值小于等于0时则不截断。</p></li><li></li></ul><p>对于第二个颜色参数，我们可以直接通过auto.ConsoleColor中的变量来获取对应常量，例如：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">auto<span class="hljs-selector-class">.Logger</span><span class="hljs-selector-class">.Write</span>(<span class="hljs-string">&#x27;测试输出&#x27;</span>, auto<span class="hljs-selector-class">.ConsoleColor</span>.Yellow)<br></code></pre></td></tr></table></figure><p>可以看一下支持的颜色列表：</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mel">colors = [<span class="hljs-keyword">color</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">color</span> <span class="hljs-keyword">in</span> dir(<br>    auto.ConsoleColor) <span class="hljs-keyword">if</span> not <span class="hljs-keyword">color</span>.startswith(<span class="hljs-string">&quot;__&quot;</span>)]<br><span class="hljs-keyword">print</span>(colors)<br><span class="hljs-number">12</span><br>[<span class="hljs-string">&#x27;Black&#x27;</span>, <span class="hljs-string">&#x27;Blue&#x27;</span>, <span class="hljs-string">&#x27;Cyan&#x27;</span>, <span class="hljs-string">&#x27;DarkBlue&#x27;</span>, <span class="hljs-string">&#x27;DarkCyan&#x27;</span>, <span class="hljs-string">&#x27;DarkGray&#x27;</span>, <span class="hljs-string">&#x27;DarkGreen&#x27;</span>, <span class="hljs-string">&#x27;DarkMagenta&#x27;</span>, <span class="hljs-string">&#x27;DarkRed&#x27;</span>, <span class="hljs-string">&#x27;DarkYellow&#x27;</span>, <span class="hljs-string">&#x27;Default&#x27;</span>, <span class="hljs-string">&#x27;Gray&#x27;</span>, <span class="hljs-string">&#x27;Green&#x27;</span>, <span class="hljs-string">&#x27;Magenta&#x27;</span>, <span class="hljs-string">&#x27;Red&#x27;</span>, <span class="hljs-string">&#x27;White&#x27;</span>, <span class="hljs-string">&#x27;Yellow&#x27;</span>]<br></code></pre></td></tr></table></figure><p>auto.Logger.WriteLine函数与auto.Logger.Write几乎等价，只是少了printTruncateLen参数。</p><p>可以使用auto.Logger.ColorfullyWrite方法对指定部分的文本修改颜色：</p><figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bnf">auto.Logger.ColorfullyWrite(&#x27;一段文本<span class="hljs-attribute">&lt;Color=Red&gt;</span>红色<span class="hljs-attribute">&lt;/Color&gt;</span>，黑色<span class="hljs-attribute">&lt;Color=Blue&gt;</span>蓝色<span class="hljs-attribute">&lt;/Color&gt;</span>结束&#x27;)<br></code></pre></td></tr></table></figure><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_11.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211116230456997"></p><p>不过以上命令的颜色效果只在有标准控制台的窗口输出才有效。</p><h2 id="全局热键与多线程"><a href="#全局热键与多线程" class="headerlink" title="全局热键与多线程"></a>全局热键与多线程</h2><p>在常规的场景中，我们一般使用pynput实现全局热键的注册，但实际上pynput相对于uiautomation库的热键功能是比较难用。</p><p>在uiautomation注册全局热键非常简单，只需要调用auto.RunByHotKey传入快捷键和函数即可。下面演示一个简单的例子，按下快捷键分别打印文本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Event<br><br><span class="hljs-keyword">import</span> uiautomation <span class="hljs-keyword">as</span> auto<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">demo1</span>(<span class="hljs-params">stopEvent: Event</span>):<br>    thread = threading.currentThread()<br>    <span class="hljs-built_in">print</span>(thread.name, thread.ident, <span class="hljs-string">&quot;demo1&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">demo2</span>(<span class="hljs-params">stopEvent: Event</span>):<br>    thread = threading.currentThread()<br>    <span class="hljs-built_in">print</span>(thread.name, thread.ident, <span class="hljs-string">&quot;demo2&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">demo3</span>(<span class="hljs-params">stopEvent: Event</span>):<br>    thread = threading.currentThread()<br>    <span class="hljs-built_in">print</span>(thread.name, thread.ident, <span class="hljs-string">&quot;demo3&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    thread = threading.currentThread()<br>    <span class="hljs-built_in">print</span>(thread.name, thread.ident, <span class="hljs-string">&quot;main&quot;</span>)<br>    auto.RunByHotKey(&#123;<br>        (<span class="hljs-number">0</span>, auto.Keys.VK_F2): demo1,<br>        (auto.ModifierKey.Control, auto.Keys.VK_1): demo2,<br>        (auto.ModifierKey.Control | auto.ModifierKey.Shift, auto.Keys.VK_2): demo3,<br>    &#125;, waitHotKeyReleased=<span class="hljs-literal">False</span>)<br><span class="hljs-number">12345678910111213141516171819</span><br></code></pre></td></tr></table></figure><p>以上代码分别注册了快捷键F2，Ctrl+1和Ctrl+Shift+2。下面测试运行该程序并分别按下这三个快捷键，最后按下Ctrl+D结束程序：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs awk">MainThread <span class="hljs-number">4404</span> main<br>Register hotkey (<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;VK_F2&#x27;</span>) successfully<br>Register hotkey (<span class="hljs-string">&#x27;Control&#x27;</span>, <span class="hljs-string">&#x27;VK_1&#x27;</span>) successfully<br>Register hotkey (<span class="hljs-string">&#x27;Control|Shift&#x27;</span>, <span class="hljs-string">&#x27;VK_2&#x27;</span>) successfully<br>Register <span class="hljs-keyword">exit</span> hotkey (<span class="hljs-string">&#x27;Control&#x27;</span>, <span class="hljs-string">&#x27;VK_D&#x27;</span>) successfully<br>----------hotkey (<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;VK_F2&#x27;</span>) pressed----------<br>Thread-<span class="hljs-number">1</span> <span class="hljs-number">4608</span> demo1<br>&lt;Thread(Thread-<span class="hljs-number">1</span>, started <span class="hljs-number">4608</span>)&gt; <span class="hljs-keyword">for</span> <span class="hljs-keyword">function</span> demo1 exits, hotkey (<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;VK_F2&#x27;</span>)<br>----------hotkey (<span class="hljs-string">&#x27;Control&#x27;</span>, <span class="hljs-string">&#x27;VK_1&#x27;</span>) pressed----------<br>Thread-<span class="hljs-number">2</span> <span class="hljs-number">12468</span> demo2<br>&lt;Thread(Thread-<span class="hljs-number">2</span>, started <span class="hljs-number">12468</span>)&gt; <span class="hljs-keyword">for</span> <span class="hljs-keyword">function</span> demo2 exits, hotkey (<span class="hljs-string">&#x27;Control&#x27;</span>, <span class="hljs-string">&#x27;VK_1&#x27;</span>)<br>----------hotkey (<span class="hljs-string">&#x27;Control|Shift&#x27;</span>, <span class="hljs-string">&#x27;VK_2&#x27;</span>) pressed----------<br>Thread-<span class="hljs-number">3</span> <span class="hljs-number">5428</span> demo3<br>&lt;Thread(Thread-<span class="hljs-number">3</span>, started <span class="hljs-number">5428</span>)&gt; <span class="hljs-keyword">for</span> <span class="hljs-keyword">function</span> demo3 exits, hotkey (<span class="hljs-string">&#x27;Control|Shift&#x27;</span>, <span class="hljs-string">&#x27;VK_2&#x27;</span>)<br>Exit hotkey pressed. Exit<br><span class="hljs-number">1234567891011121314</span><br></code></pre></td></tr></table></figure><p>由于每次按下热键都会启动独立的线程执行该函数，从打印日志可以看到每次按下执行函数的线程都不同。</p><p>RunByHotKey的参数列表如下：</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs fortran">RunByHotKey(keyFunctions: Dict[Tuple[<span class="hljs-built_in">int</span>, <span class="hljs-built_in">int</span>], (...) -&gt; <span class="hljs-built_in">Any</span>],<br>                stopHotKey: <span class="hljs-keyword">Optional</span>[Tuple[<span class="hljs-built_in">int</span>, <span class="hljs-built_in">int</span>]] = <span class="hljs-keyword">None</span>,<br>                exitHotKey: Tuple[<span class="hljs-built_in">int</span>, <span class="hljs-built_in">int</span>] = (ModifierKey.Control, Keys.VK_D),<br>                waitHotKeyReleased: bool = True)<br><span class="hljs-number">123</span><br></code></pre></td></tr></table></figure><p>其中exitHotKey表示程序退出的快捷键，默认为Ctrl+D。waitHotKeyReleased表示是否等待弹起后执行，经测试设置为False不等待更佳。</p><p>stopHotKey表示产生退出事件的快捷键，当我们设置该参数并在运行中按下该快捷键，函数的参数stopEvent将会被设置，调用.is_set()将会返回True。</p><p>我们可以在热键需要执行一个耗时较长的循环操作时，在循环中判断该事件是否被设置，设置就退出循环。</p><p>演示一个简单的示例，按下Ctrl+S启动热键，每0.5秒打印一个数字直到10，按下Ctrl+E则中断热键执行。重新按下Ctrl+S还可以继续：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Event<br><br><span class="hljs-keyword">import</span> uiautomation <span class="hljs-keyword">as</span> auto<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">demo1</span>(<span class="hljs-params">stopEvent: Event</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>        <span class="hljs-keyword">if</span> stopEvent.is_set():<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;退出循环&quot;</span>)<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-built_in">print</span>(i, end=<span class="hljs-string">&quot; &quot;</span>)<br>        stopEvent.wait(<span class="hljs-number">0.5</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    thread = threading.currentThread()<br>    <span class="hljs-built_in">print</span>(thread.name, thread.ident, <span class="hljs-string">&quot;main&quot;</span>)<br>    auto.RunByHotKey(&#123;<br>        (<span class="hljs-number">0</span>, auto.Keys.VK_S): demo1,<br>    &#125;, stopHotKey=(<span class="hljs-number">0</span>, auto.Keys.VK_E),<br>        waitHotKeyReleased=<span class="hljs-literal">True</span>)<br><span class="hljs-number">12345678910111213141516</span><br></code></pre></td></tr></table></figure><p>测试一下：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">Register hotkey (<span class="hljs-string">&#x27;Control&#x27;</span>, <span class="hljs-string">&#x27;VK_S&#x27;</span>) successfully<br>Register stop hotkey (<span class="hljs-string">&#x27;Control&#x27;</span>, <span class="hljs-string">&#x27;VK_E&#x27;</span>) successfully<br>Register <span class="hljs-keyword">exit</span> hotkey (<span class="hljs-string">&#x27;Control&#x27;</span>, <span class="hljs-string">&#x27;VK_D&#x27;</span>) successfully<br>----------hotkey (<span class="hljs-string">&#x27;Control&#x27;</span>, <span class="hljs-string">&#x27;VK_S&#x27;</span>) pressed----------<br><span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> ----------stop hotkey pressed----------<br>退出热键被按下，结束！<br>&lt;Thread(Thread-<span class="hljs-number">1</span>, started <span class="hljs-number">10016</span>)&gt; <span class="hljs-keyword">for</span> <span class="hljs-keyword">function</span> demo1 exits, hotkey (<span class="hljs-string">&#x27;Control&#x27;</span>, <span class="hljs-string">&#x27;VK_S&#x27;</span>)<br>Exit hotkey pressed. Exit<br><span class="hljs-number">1234567</span><br></code></pre></td></tr></table></figure><p>需要注意在线程中需要使用控件对象相关方法时，要在新线程中进行相应的初始化：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scss">auto<span class="hljs-selector-class">.InitializeUIAutomationInCurrentThread</span>()<br>...<br>auto<span class="hljs-selector-class">.UninitializeUIAutomationInCurrentThread</span>()<br><span class="hljs-number">12</span><br></code></pre></td></tr></table></figure><p>也可以使用with语句简化代码：</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs coq"><span class="hljs-built_in">with</span> <span class="hljs-built_in">auto</span>.UIAutomationInitializerInThread():<br>    pass<br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>…和pass替换为线程中实际操作的代码。</p><blockquote><p>⚠️：否则部分场景下会报错。</p></blockquote><h2 id="管理员提权"><a href="#管理员提权" class="headerlink" title="管理员提权"></a>管理员提权</h2><p>模板代码为：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> auto<span class="hljs-selector-class">.IsUserAnAdmin</span>():<br>        <span class="hljs-selector-tag">main</span>()<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;RunScriptAsAdmin&#x27;</span>, sys<span class="hljs-selector-class">.executable</span>, sys.argv)<br>        auto<span class="hljs-selector-class">.RunScriptAsAdmin</span>(sys.argv)<br><span class="hljs-number">12345</span><br></code></pre></td></tr></table></figure><p>将原本存在于__main__代码块中的内容存放于main()方法中即可。</p><h1 id="通过实例学习UI自动化"><a href="#通过实例学习UI自动化" class="headerlink" title="通过实例学习UI自动化"></a>通过实例学习UI自动化</h1><h2 id="控制win10计算器自动计算"><a href="#控制win10计算器自动计算" class="headerlink" title="控制win10计算器自动计算"></a>控制win10计算器自动计算</h2><p>自动控制计算器更简单的方法是复制粘贴需要计算的字符串到计算器，但本节的目的为了演示点击按钮计算的效果。</p><p>首先启动计算器并设置窗口置顶：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">import</span> uiautomation as auto<br><span class="hljs-attribute">import</span> os<br><span class="hljs-attribute">import</span> sys<br><span class="hljs-attribute">import</span> time<br><span class="hljs-attribute">import</span> subprocess<br><br><span class="hljs-comment"># 显示搜索控件所遍历的控件数和搜索时间</span><br><span class="hljs-attribute">auto</span>.uiautomation.DEBUG_SEARCH_TIME = True<br><span class="hljs-comment"># 设置全局搜索超时时间为1秒</span><br><span class="hljs-attribute">auto</span>.uiautomation.SetGlobalSearchTimeout(<span class="hljs-number">1</span>)<br><span class="hljs-comment"># 创建计算器窗口控件</span><br><span class="hljs-attribute">calcWindow</span> = auto.WindowControl(<br>    <span class="hljs-attribute">searchDepth</span>=<span class="hljs-number">1</span>, ClassName=&#x27;ApplicationFrameWindow&#x27;, Compare = lambda c,d : c.Name == &#x27;Calculator&#x27; or c.Name == &#x27;计算器&#x27;, desc=&#x27;计算器窗口&#x27;)<br><span class="hljs-attribute">if</span> not calcWindow.Exists(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>):<br>    <span class="hljs-attribute">subprocess</span>.Popen(&#x27;calc&#x27;)<br><span class="hljs-comment"># 设置窗口前置</span><br><span class="hljs-attribute">calcWindow</span>.SetTopmost(True)<br><span class="hljs-attribute">123456789101112131415</span><br><span class="hljs-attribute">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">21</span> <span class="hljs-number">23</span>:<span class="hljs-number">10</span>:<span class="hljs-number">34</span>.<span class="hljs-number">990</span> &lt;ipython-input-<span class="hljs-number">5</span>-ff74c0c97515&gt;[<span class="hljs-number">17</span>] &lt;module&gt; -&gt; &#123;ClassName: &#x27;ApplicationFrameWindow&#x27;, desc: &#x27;计算器窗口&#x27;, ControlType: WindowControl&#125; TraverseControls: <span class="hljs-number">2</span>, SearchTime: <span class="hljs-number">1</span>.<span class="hljs-number">004</span>s[<span class="hljs-number">23</span>:<span class="hljs-number">10</span>:<span class="hljs-number">33</span>.<span class="hljs-number">984967</span> - <span class="hljs-number">23</span>:<span class="hljs-number">10</span>:<span class="hljs-number">34</span>.<span class="hljs-number">990062</span>]<br></code></pre></td></tr></table></figure><blockquote><p>⚠️ Compare参数可以传入自定义搜索函数，两个参数分别为控件对象和搜索深度。上述代码能够适配Name属性可能为中文或英文的情况。 不过ClassName参数足够定位到计算器窗口，Compare参数可以直接删除。 Desc是无效的属性，可以在debug日志中打印出来，当然任何无效属性都可以在debug日志中打印出来。 calcWindow.Exists(0, 0)判断了计算器窗口是否已经存在，防止重复打开新的窗口。</p></blockquote><p>切换到科学计算器：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 调低waitTime可以加快点击速度</span><br><span class="hljs-attribute">calcWindow</span>.ButtonControl(AutomationId=&#x27;TogglePaneButton&#x27;,<br>                         <span class="hljs-attribute">desc</span>=&#x27;打开导航&#x27;).Click(waitTime=<span class="hljs-number">0</span>.<span class="hljs-number">01</span>)<br><span class="hljs-attribute">calcWindow</span>.ListItemControl(AutomationId=&#x27;Scientific&#x27;,<br>                           <span class="hljs-attribute">desc</span>=&#x27;选择科学计算器&#x27;).Click(waitTime=<span class="hljs-number">0</span>.<span class="hljs-number">01</span>)<br><span class="hljs-attribute">clearButton</span> = calcWindow.ButtonControl(AutomationId=&#x27;clearEntryButton&#x27;,<br>                                       <span class="hljs-attribute">desc</span>=&#x27;点击CE清空所有输入&#x27;)<br><span class="hljs-attribute">if</span> clearButton.Exists(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>):<br>    <span class="hljs-attribute">clearButton</span>.Click(waitTime=<span class="hljs-number">0</span>)<br><span class="hljs-attribute">else</span>:<br>    <span class="hljs-attribute">calcWindow</span>.ButtonControl(AutomationId=&#x27;clearButton&#x27;,<br>                             <span class="hljs-attribute">desc</span>=&#x27;点击C清空所有输入&#x27;).Click(waitTime=<span class="hljs-number">0</span>)<br><span class="hljs-attribute">1234567891011</span><br><span class="hljs-attribute">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">21</span> <span class="hljs-number">23</span>:<span class="hljs-number">22</span>:<span class="hljs-number">28</span>.<span class="hljs-number">966</span> &lt;ipython-input-<span class="hljs-number">10</span>-a63d4ee11410&gt;[<span class="hljs-number">3</span>] &lt;module&gt; -&gt; &#123;AutomationId: &#x27;TogglePaneButton&#x27;, desc: &#x27;打开导航&#x27;, ControlType: ButtonControl&#125; TraverseControls: <span class="hljs-number">121</span>, SearchTime: <span class="hljs-number">0</span>.<span class="hljs-number">061</span>s[<span class="hljs-number">23</span>:<span class="hljs-number">22</span>:<span class="hljs-number">28</span>.<span class="hljs-number">906224</span> - <span class="hljs-number">23</span>:<span class="hljs-number">22</span>:<span class="hljs-number">28</span>.<span class="hljs-number">966385</span>]<br><span class="hljs-attribute">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">21</span> <span class="hljs-number">23</span>:<span class="hljs-number">22</span>:<span class="hljs-number">29</span>.<span class="hljs-number">518</span> &lt;ipython-input-<span class="hljs-number">10</span>-a63d4ee11410&gt;[<span class="hljs-number">5</span>] &lt;module&gt; -&gt; &#123;AutomationId: &#x27;Scientific&#x27;, desc: &#x27;选择科学计算器&#x27;, ControlType: ListItemControl&#125; TraverseControls: <span class="hljs-number">133</span>, SearchTime: <span class="hljs-number">0</span>.<span class="hljs-number">077</span>s[<span class="hljs-number">23</span>:<span class="hljs-number">22</span>:<span class="hljs-number">29</span>.<span class="hljs-number">442885</span> - <span class="hljs-number">23</span>:<span class="hljs-number">22</span>:<span class="hljs-number">29</span>.<span class="hljs-number">518933</span>]<br><span class="hljs-attribute">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">21</span> <span class="hljs-number">23</span>:<span class="hljs-number">22</span>:<span class="hljs-number">29</span>.<span class="hljs-number">876</span> &lt;ipython-input-<span class="hljs-number">10</span>-a63d4ee11410&gt;[<span class="hljs-number">12</span>] &lt;module&gt; -&gt; &#123;AutomationId: &#x27;clearButton&#x27;, desc: &#x27;点击C清空所有输入&#x27;, ControlType: ButtonControl&#125; TraverseControls: <span class="hljs-number">51</span>, SearchTime: <span class="hljs-number">0</span>.<span class="hljs-number">029</span>s[<span class="hljs-number">23</span>:<span class="hljs-number">22</span>:<span class="hljs-number">29</span>.<span class="hljs-number">846955</span> - <span class="hljs-number">23</span>:<span class="hljs-number">22</span>:<span class="hljs-number">29</span>.<span class="hljs-number">876364</span>]<br><span class="hljs-attribute">12</span><br></code></pre></td></tr></table></figure><blockquote><p>⚠️清空按钮在输入框有数和没有数时，按钮的标题和AutomationId不一样，所以先判断其中一种情况的按钮是否存在，不存在则切换到另一种形式的按钮进行点击。</p></blockquote><p>其中按钮的AutomationId属性可以通过inspect.exe工具或automation.py脚本获取。</p><p>下面只演示四则运算，先通过inspect.exe工具获取每个按钮控件对应的AutomationId：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_12.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20210921235027029"></p><p>然后通过auto.WalkControl遍历所有控件，从而缓存每个字符对应的按钮控件：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs stylus">id2char = &#123;<br>    <span class="hljs-string">&#x27;num0Button&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br>    <span class="hljs-string">&#x27;num1Button&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>,<br>    <span class="hljs-string">&#x27;num2Button&#x27;</span>: <span class="hljs-string">&#x27;2&#x27;</span>,<br>    <span class="hljs-string">&#x27;num3Button&#x27;</span>: <span class="hljs-string">&#x27;3&#x27;</span>,<br>    <span class="hljs-string">&#x27;num4Button&#x27;</span>: <span class="hljs-string">&#x27;4&#x27;</span>,<br>    <span class="hljs-string">&#x27;num5Button&#x27;</span>: <span class="hljs-string">&#x27;5&#x27;</span>,<br>    <span class="hljs-string">&#x27;num6Button&#x27;</span>: <span class="hljs-string">&#x27;6&#x27;</span>,<br>    <span class="hljs-string">&#x27;num7Button&#x27;</span>: <span class="hljs-string">&#x27;7&#x27;</span>,<br>    <span class="hljs-string">&#x27;num8Button&#x27;</span>: <span class="hljs-string">&#x27;8&#x27;</span>,<br>    <span class="hljs-string">&#x27;num9Button&#x27;</span>: <span class="hljs-string">&#x27;9&#x27;</span>,<br>    <span class="hljs-string">&#x27;decimalSeparatorButton&#x27;</span>: <span class="hljs-string">&#x27;.&#x27;</span>,<br>    <span class="hljs-string">&#x27;plusButton&#x27;</span>: <span class="hljs-string">&#x27;+&#x27;</span>,<br>    <span class="hljs-string">&#x27;minusButton&#x27;</span>: <span class="hljs-string">&#x27;-&#x27;</span>,<br>    <span class="hljs-string">&#x27;multiplyButton&#x27;</span>: <span class="hljs-string">&#x27;*&#x27;</span>,<br>    <span class="hljs-string">&#x27;divideButton&#x27;</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>    <span class="hljs-string">&#x27;equalButton&#x27;</span>: <span class="hljs-string">&#x27;=&#x27;</span>,<br>    <span class="hljs-string">&#x27;openParenthesisButton&#x27;</span>: <span class="hljs-string">&#x27;(&#x27;</span>,<br>    <span class="hljs-string">&#x27;closeParenthesisButton&#x27;</span>: <span class="hljs-string">&#x27;)&#x27;</span><br>&#125;<br>char2Button = &#123;&#125;<br><span class="hljs-keyword">for</span> c, d <span class="hljs-keyword">in</span> auto<span class="hljs-selector-class">.WalkControl</span>(calcWindow, maxDepth=<span class="hljs-number">4</span>):<br>    <span class="hljs-keyword">if</span> c<span class="hljs-selector-class">.AutomationId</span> <span class="hljs-keyword">in</span> id2char:<br>        char2Button<span class="hljs-selector-attr">[id2char[c.AutomationId]</span>] = c<br><span class="hljs-number">1234567891011121314151617181920212223</span><br></code></pre></td></tr></table></figure><p>然后封装一下对四则运算表达式计算的函数：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs scss">def <span class="hljs-built_in">calc</span>(expression):<br>    expression = <span class="hljs-string">&#x27;&#x27;</span>.<span class="hljs-built_in">join</span>(expression.<span class="hljs-built_in">split</span>())<br>    if not expression.<span class="hljs-built_in">endswith</span>(<span class="hljs-string">&#x27;=&#x27;</span>):<br>        expression += <span class="hljs-string">&#x27;=&#x27;</span><br>    for char in expression:<br>        char2Button[char].<span class="hljs-built_in">Click</span>(waitTime=<span class="hljs-number">0</span>)<br>    time.<span class="hljs-built_in">sleep</span>(<span class="hljs-number">0.1</span>)<br>    calcWindow.<span class="hljs-built_in">SendKeys</span>(<span class="hljs-string">&#x27;&#123;Ctrl&#125;c&#x27;</span>, waitTime=<span class="hljs-number">0.1</span>)<br>    return auto.<span class="hljs-built_in">GetClipboardText</span>()<br><span class="hljs-number">12345678</span><br></code></pre></td></tr></table></figure><p>测试一个四则表达式：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">calc</span>(&#x27;<span class="hljs-number">1234</span> * (<span class="hljs-number">4</span> + <span class="hljs-number">5</span> + <span class="hljs-number">6</span>) - <span class="hljs-number">78</span> / <span class="hljs-number">90</span>.<span class="hljs-number">8</span>&#x27;)<br></code></pre></td></tr></table></figure><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_13.gif" srcset="/img/loading.gif" lazyload alt="img"></p><p>需要截屏的话可以调用如下命令：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">calcWindow.CaptureToImage(<span class="hljs-string">&#x27;calc.png&#x27;</span>, <span class="hljs-attribute">x</span>=7, <span class="hljs-attribute">y</span>=0, <span class="hljs-attribute">width</span>=-14, <span class="hljs-attribute">height</span>=-7)<br></code></pre></td></tr></table></figure><blockquote><p>⚠️x和y表示起始坐标，由于win10的计算器存在7像素的阴影，所以可以去掉。 width和height为负数时，表示原宽度减少指定值。垂直方向上只有下方有阴影，水平方向上左右均有阴影。</p></blockquote><p>关闭程序只需调用：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">calcWindow.<span class="hljs-constructor">GetWindowPattern()</span>.<span class="hljs-constructor">Close()</span><br></code></pre></td></tr></table></figure><p><strong>完整代码：</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs routeros">import uiautomation as auto<br>import os<br>import sys<br>import time<br>import subprocess<br><br><span class="hljs-comment"># 显示搜索控件所遍历的控件数和搜索时间</span><br>auto.uiautomation.DEBUG_SEARCH_TIME = <span class="hljs-literal">True</span><br><span class="hljs-comment"># 设置全局搜索超时时间为1秒</span><br>auto.uiautomation.SetGlobalSearchTimeout(1)<br><span class="hljs-comment"># 创建计算器窗口控件</span><br>calcWindow = auto.WindowControl(<br>    <span class="hljs-attribute">searchDepth</span>=1, <span class="hljs-attribute">ClassName</span>=<span class="hljs-string">&#x27;ApplicationFrameWindow&#x27;</span>, <span class="hljs-attribute">desc</span>=<span class="hljs-string">&#x27;计算器窗口&#x27;</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> calcWindow.Exists(0, 0):<br>    subprocess.Popen(<span class="hljs-string">&#x27;calc&#x27;</span>)<br><span class="hljs-comment"># 设置窗口前置</span><br>calcWindow.SetTopmost(<span class="hljs-literal">True</span>)<br><span class="hljs-comment"># 调低waitTime可以加快点击速度</span><br>calcWindow.ButtonControl(<span class="hljs-attribute">AutomationId</span>=<span class="hljs-string">&#x27;TogglePaneButton&#x27;</span>,<br>                         <span class="hljs-attribute">desc</span>=<span class="hljs-string">&#x27;打开导航&#x27;</span>).Click(waitTime=0.01)<br>calcWindow.ListItemControl(<span class="hljs-attribute">AutomationId</span>=<span class="hljs-string">&#x27;Scientific&#x27;</span>,<br>                           <span class="hljs-attribute">desc</span>=<span class="hljs-string">&#x27;选择科学计算器&#x27;</span>).Click(waitTime=0.01)<br>clearButton = calcWindow.ButtonControl(<span class="hljs-attribute">AutomationId</span>=<span class="hljs-string">&#x27;clearEntryButton&#x27;</span>,<br>                                       <span class="hljs-attribute">desc</span>=<span class="hljs-string">&#x27;点击CE清空所有输入&#x27;</span>)<br><span class="hljs-keyword">if</span> clearButton.Exists(0, 0):<br>    clearButton.Click(<span class="hljs-attribute">waitTime</span>=0)<br><span class="hljs-keyword">else</span>:<br>    calcWindow.ButtonControl(<span class="hljs-attribute">AutomationId</span>=<span class="hljs-string">&#x27;clearButton&#x27;</span>,<br>                             <span class="hljs-attribute">desc</span>=<span class="hljs-string">&#x27;点击C清空所有输入&#x27;</span>).Click(waitTime=0)<br>id2char = &#123;<br>    <span class="hljs-string">&#x27;num0Button&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br>    <span class="hljs-string">&#x27;num1Button&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>,<br>    <span class="hljs-string">&#x27;num2Button&#x27;</span>: <span class="hljs-string">&#x27;2&#x27;</span>,<br>    <span class="hljs-string">&#x27;num3Button&#x27;</span>: <span class="hljs-string">&#x27;3&#x27;</span>,<br>    <span class="hljs-string">&#x27;num4Button&#x27;</span>: <span class="hljs-string">&#x27;4&#x27;</span>,<br>    <span class="hljs-string">&#x27;num5Button&#x27;</span>: <span class="hljs-string">&#x27;5&#x27;</span>,<br>    <span class="hljs-string">&#x27;num6Button&#x27;</span>: <span class="hljs-string">&#x27;6&#x27;</span>,<br>    <span class="hljs-string">&#x27;num7Button&#x27;</span>: <span class="hljs-string">&#x27;7&#x27;</span>,<br>    <span class="hljs-string">&#x27;num8Button&#x27;</span>: <span class="hljs-string">&#x27;8&#x27;</span>,<br>    <span class="hljs-string">&#x27;num9Button&#x27;</span>: <span class="hljs-string">&#x27;9&#x27;</span>,<br>    <span class="hljs-string">&#x27;decimalSeparatorButton&#x27;</span>: <span class="hljs-string">&#x27;.&#x27;</span>,<br>    <span class="hljs-string">&#x27;plusButton&#x27;</span>: <span class="hljs-string">&#x27;+&#x27;</span>,<br>    <span class="hljs-string">&#x27;minusButton&#x27;</span>: <span class="hljs-string">&#x27;-&#x27;</span>,<br>    <span class="hljs-string">&#x27;multiplyButton&#x27;</span>: <span class="hljs-string">&#x27;*&#x27;</span>,<br>    <span class="hljs-string">&#x27;divideButton&#x27;</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>    <span class="hljs-string">&#x27;equalButton&#x27;</span>: <span class="hljs-string">&#x27;=&#x27;</span>,<br>    <span class="hljs-string">&#x27;openParenthesisButton&#x27;</span>: <span class="hljs-string">&#x27;(&#x27;</span>,<br>    <span class="hljs-string">&#x27;closeParenthesisButton&#x27;</span>: <span class="hljs-string">&#x27;)&#x27;</span><br>&#125;<br>char2Button = &#123;&#125;<br><span class="hljs-keyword">for</span> c, d <span class="hljs-keyword">in</span> auto.WalkControl(calcWindow, <span class="hljs-attribute">maxDepth</span>=4):<br>    <span class="hljs-keyword">if</span> c.AutomationId <span class="hljs-keyword">in</span> id2char:<br>        char2Button[id2char[c.AutomationId]] = c<br><br><br>def calc(expression):<br>    expression = <span class="hljs-string">&#x27;&#x27;</span>.join(expression.split())<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> expression.endswith(<span class="hljs-string">&#x27;=&#x27;</span>):<br>        expression += <span class="hljs-string">&#x27;=&#x27;</span><br>    <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> expression:<br>        char2Button[char].Click(<span class="hljs-attribute">waitTime</span>=0)<br>    time.sleep(0.1)<br>    calcWindow.SendKeys(<span class="hljs-string">&#x27;&#123;Ctrl&#125;c&#x27;</span>, <span class="hljs-attribute">waitTime</span>=0.1)<br>    return auto.GetClipboardText()<br><br><br>result = calc(<span class="hljs-string">&#x27;1234 * (4 + 5 + 6) - 78 / 90.8&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;1234 * (4 + 5 + 6) - 78 / 90.8 =&#x27;</span>, result)<br>result = calc(<span class="hljs-string">&#x27;3*3+4*4&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;3*3+4*4 =&#x27;</span>, result)<br>result = calc(<span class="hljs-string">&#x27;2*3.14159*10&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;2*3.14159*10 =&#x27;</span>, result)<br>calcWindow.CaptureToImage(<span class="hljs-string">&#x27;calc.png&#x27;</span>, <span class="hljs-attribute">x</span>=7, <span class="hljs-attribute">y</span>=0, <span class="hljs-attribute">width</span>=-14, <span class="hljs-attribute">height</span>=-7)<br>calcWindow.GetWindowPattern().Close()<br>1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768<br></code></pre></td></tr></table></figure><p>结果：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1234</span> * (<span class="hljs-number">4</span> + <span class="hljs-number">5</span> + <span class="hljs-number">6</span>) - <span class="hljs-number">78</span> / <span class="hljs-number">90</span>.<span class="hljs-number">8</span> = <span class="hljs-number">18509</span>.<span class="hljs-number">140969162995594713656387665</span><br><span class="hljs-attribute">3</span>*<span class="hljs-number">3</span>+<span class="hljs-number">4</span>*<span class="hljs-number">4</span> = <span class="hljs-number">25</span><br><span class="hljs-attribute">2</span>*<span class="hljs-number">3</span>.<span class="hljs-number">14159</span>*<span class="hljs-number">10</span> = <span class="hljs-number">62</span>.<span class="hljs-number">8318</span><br><span class="hljs-attribute">12</span><br></code></pre></td></tr></table></figure><p>产生的截图：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_14.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211111210023786"></p><p>运行过程中的原速动图：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_15.gif" srcset="/img/loading.gif" lazyload alt="请添加图片描述"></p><h2 id="窗口的拖拽与缩放"><a href="#窗口的拖拽与缩放" class="headerlink" title="窗口的拖拽与缩放"></a>窗口的拖拽与缩放</h2><p>下面我们使用一个记事本窗口作为前置窗口就行演示，首先打开记事本窗口：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">import sys<br>import time<br>import subprocess<br><br>import uiautomation <span class="hljs-keyword">as</span> auto<br># 设置全局搜索超时时间为<span class="hljs-number">1</span>秒<br>auto.uiautomation.<span class="hljs-constructor">SetGlobalSearchTimeout(1)</span><br><br>note = auto.<span class="hljs-constructor">WindowControl(<span class="hljs-params">searchDepth</span>=1, ClassName=&#x27;Notepad&#x27;)</span><br><span class="hljs-keyword">if</span> not note.<span class="hljs-constructor">Exists(0, 0)</span>:<br>    subprocess.<span class="hljs-constructor">Popen(&#x27;<span class="hljs-params">notepad</span>.<span class="hljs-params">exe</span>&#x27;)</span><br>note.<span class="hljs-constructor">SetActive()</span><br>note.<span class="hljs-constructor">SetTopmost(<span class="hljs-params">waitTime</span>=0)</span><br><span class="hljs-number">12345678910</span><br></code></pre></td></tr></table></figure><p>调整窗口位置和大小后，输入文本：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 移动窗口的位置，前两个参数表示左上角的位置，后两个参数编程窗口大小</span><br><span class="hljs-attribute">note</span>.MoveWindow(<span class="hljs-number">300</span>, <span class="hljs-number">70</span>, <span class="hljs-number">480</span>, <span class="hljs-number">400</span>)<br><span class="hljs-attribute">edit</span> = note.EditControl()<br><span class="hljs-attribute">edit</span>.SendKeys(&#x27;&#123;Ctrl&#125;&#123;End&#125;&#123;Enter <span class="hljs-number">2</span>&#125;我是置顶窗口!!!\n我将遮住其他窗口.&#x27;)<br><span class="hljs-attribute">123</span><br></code></pre></td></tr></table></figure><p>打开计算器窗口并调整：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 打开计算器窗口并调整：</span><br><span class="hljs-attribute">calcWindow</span> = auto.WindowControl(<br>    <span class="hljs-attribute">searchDepth</span>=<span class="hljs-number">1</span>, ClassName=&#x27;ApplicationFrameWindow&#x27;)<br><span class="hljs-attribute">if</span> not calcWindow.Exists(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>):<br>    <span class="hljs-attribute">subprocess</span>.Popen(&#x27;calc&#x27;)<br><span class="hljs-attribute">calcWindow</span>.SetActive()<br><span class="hljs-attribute">calcWindow</span>.MoveWindow(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">320</span>, <span class="hljs-number">500</span>)<br><span class="hljs-attribute">123456</span><br></code></pre></td></tr></table></figure><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_16.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211112202543934"></p><p>再进行本例最精彩的部分，以拖拽方式移动窗口：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 鼠标从位置(240, 110)拖拽到(840, 110)</span><br><span class="hljs-attribute">auto</span>.DragDrop(<span class="hljs-number">240</span>, <span class="hljs-number">110</span>, <span class="hljs-number">840</span>, <span class="hljs-number">110</span>, waitTime=<span class="hljs-number">0</span>.<span class="hljs-number">1</span>)<br><span class="hljs-comment"># 再拖拽回去</span><br><span class="hljs-attribute">auto</span>.DragDrop(<span class="hljs-number">840</span>, <span class="hljs-number">110</span>, <span class="hljs-number">240</span>, <span class="hljs-number">110</span>, waitTime=<span class="hljs-number">0</span>.<span class="hljs-number">1</span>)<br><span class="hljs-attribute">123</span><br></code></pre></td></tr></table></figure><p>最后打印文本并关闭窗口：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">calcWindow.<span class="hljs-constructor">GetWindowPattern()</span>.<span class="hljs-constructor">Close()</span><br>edit.<span class="hljs-constructor">SendKeys(&#x27;&#123;Ctrl&#125;&#123;End&#125;&#123;Enter 2&#125;关闭计算器窗口&#x27;)</span><br>vp = edit.<span class="hljs-constructor">GetValuePattern()</span><br>print(&#x27;当前文本:&#x27;, vp.Value)<br># 激活记事本窗口<br>note.<span class="hljs-constructor">SetActive()</span><br>note.<span class="hljs-constructor">GetWindowPattern()</span>.<span class="hljs-constructor">Close()</span><br># 确认不保存<br>auto.<span class="hljs-constructor">SendKeys(&#x27;&#123;ALT&#125;<span class="hljs-params">n</span>&#x27;)</span><br><span class="hljs-number">12345678</span><br></code></pre></td></tr></table></figure><p><strong>完整代码：</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">import</span> sys<br><span class="hljs-attribute">import</span> time<br><span class="hljs-attribute">import</span> subprocess<br><br><span class="hljs-attribute">import</span> uiautomation as auto<br><span class="hljs-comment"># 设置全局搜索超时时间为1秒</span><br><span class="hljs-attribute">auto</span>.uiautomation.SetGlobalSearchTimeout(<span class="hljs-number">1</span>)<br><br><span class="hljs-attribute">note</span> = auto.WindowControl(searchDepth=<span class="hljs-number">1</span>, ClassName=&#x27;Notepad&#x27;)<br><span class="hljs-attribute">if</span> not note.Exists(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>):<br>    <span class="hljs-attribute">subprocess</span>.Popen(&#x27;notepad.exe&#x27;)<br><span class="hljs-attribute">note</span>.SetActive()<br><span class="hljs-attribute">note</span>.SetTopmost(waitTime=<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># 移动窗口的位置，前两个参数表示左上角的位置，后两个参数编程窗口大小</span><br><span class="hljs-attribute">note</span>.MoveWindow(<span class="hljs-number">300</span>, <span class="hljs-number">70</span>, <span class="hljs-number">480</span>, <span class="hljs-number">400</span>)<br><span class="hljs-attribute">edit</span> = note.EditControl()<br><span class="hljs-attribute">edit</span>.SendKeys(&#x27;&#123;Ctrl&#125;&#123;End&#125;&#123;Enter <span class="hljs-number">2</span>&#125;我是置顶窗口!!!\n我将遮住其他窗口.&#x27;)<br><span class="hljs-comment"># 打开计算器窗口并调整：</span><br><span class="hljs-attribute">calcWindow</span> = auto.WindowControl(<br>    <span class="hljs-attribute">searchDepth</span>=<span class="hljs-number">1</span>, ClassName=&#x27;ApplicationFrameWindow&#x27;)<br><span class="hljs-attribute">if</span> not calcWindow.Exists(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>):<br>    <span class="hljs-attribute">subprocess</span>.Popen(&#x27;calc&#x27;)<br><span class="hljs-attribute">calcWindow</span>.SetActive()<br><span class="hljs-attribute">calcWindow</span>.MoveWindow(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">320</span>, <span class="hljs-number">500</span>)<br><span class="hljs-comment"># 鼠标从位置(240, 110)拖拽到(840, 110)</span><br><span class="hljs-attribute">auto</span>.DragDrop(<span class="hljs-number">240</span>, <span class="hljs-number">110</span>, <span class="hljs-number">840</span>, <span class="hljs-number">110</span>, waitTime=<span class="hljs-number">0</span>.<span class="hljs-number">1</span>)<br><span class="hljs-comment"># 再拖拽回去</span><br><span class="hljs-attribute">auto</span>.DragDrop(<span class="hljs-number">840</span>, <span class="hljs-number">110</span>, <span class="hljs-number">240</span>, <span class="hljs-number">110</span>, waitTime=<span class="hljs-number">0</span>.<span class="hljs-number">1</span>)<br><span class="hljs-comment"># 打印文本并关闭窗口：</span><br><span class="hljs-attribute">calcWindow</span>.GetWindowPattern().Close()<br><span class="hljs-attribute">edit</span>.SendKeys(&#x27;&#123;Ctrl&#125;&#123;End&#125;&#123;Enter <span class="hljs-number">2</span>&#125;关闭计算器窗口&#x27;)<br><span class="hljs-attribute">vp</span> = edit.GetValuePattern()<br><span class="hljs-attribute">print</span>(&#x27;当前文本:&#x27;, vp.Value)<br><span class="hljs-comment"># 激活记事本窗口</span><br><span class="hljs-attribute">note</span>.SetActive()<br><span class="hljs-attribute">note</span>.GetWindowPattern().Close()<br><span class="hljs-comment"># 确认不保存</span><br><span class="hljs-attribute">auto</span>.SendKeys(&#x27;&#123;ALT&#125;n&#x27;)<br><span class="hljs-attribute">1234567891011121314151617181920212223242526272829303132333435</span><br></code></pre></td></tr></table></figure><p>运行效果(图片使用了全局色键压缩，导致颜色失真)：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_17.gif" srcset="/img/loading.gif" lazyload alt="请添加图片描述"></p><h2 id="管理员提权操作并读取设备管理器栏目数据"><a href="#管理员提权操作并读取设备管理器栏目数据" class="headerlink" title="管理员提权操作并读取设备管理器栏目数据"></a>管理员提权操作并读取设备管理器栏目数据</h2><p>由于必须要有管理员权限才能读取设备管理器，在没有管理员权限的控制台需要进行管理员身份提权。本案例涉及很多小知识点，下面先拆分来单独列出来。</p><p><strong>获取屏幕大小：</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scss">auto<span class="hljs-selector-class">.GetScreenSize</span>()<br>(<span class="hljs-number">1920</span>, <span class="hljs-number">1080</span>)<br></code></pre></td></tr></table></figure><p>获取当前运行的程序的控制台并移动：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">sw, sh = auto.<span class="hljs-constructor">GetScreenSize()</span><br>cmdWindow = auto.<span class="hljs-constructor">GetConsoleWindow()</span><br><span class="hljs-keyword">if</span> cmdWindow:<br>    cmdTransformPattern = cmdWindow.<span class="hljs-constructor">GetTransformPattern()</span><br>    cmdTransformPattern.<span class="hljs-constructor">Move(<span class="hljs-params">sw</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 2, 0)</span><br>    cmdTransformPattern.<span class="hljs-constructor">Resize(<span class="hljs-params">sw</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 2, <span class="hljs-params">sh</span> <span class="hljs-operator">*</span> 3 <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 4)</span><br><span class="hljs-number">12345</span><br></code></pre></td></tr></table></figure><p>打开设置管理器并修改窗口大小和位置：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">subprocess.<span class="hljs-constructor">Popen(&#x27;<span class="hljs-params">mmc</span>.<span class="hljs-params">exe</span> <span class="hljs-params">devmgmt</span>.<span class="hljs-params">msc</span>&#x27;)</span><br>mmcWindow = auto.<span class="hljs-constructor">WindowControl(<span class="hljs-params">searchDepth</span> = 1, ClassName = &#x27;MMCMainFrame&#x27;)</span><br>mmcTransformPattern = mmcWindow.<span class="hljs-constructor">GetTransformPattern()</span><br>mmcTransformPattern.<span class="hljs-constructor">Move(0, 0)</span><br>mmcTransformPattern.<span class="hljs-constructor">Resize(<span class="hljs-params">sw</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 2, <span class="hljs-params">sh</span> <span class="hljs-operator">*</span> 3 <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 4)</span><br><span class="hljs-number">1234</span><br></code></pre></td></tr></table></figure><p>下面我们的目标是提取出设备管理器的每一项的信息：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_18.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211112221747877"></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">tree = mmcWindow.<span class="hljs-constructor">TreeControl()</span><br><span class="hljs-keyword">for</span> item, depth <span class="hljs-keyword">in</span> auto.<span class="hljs-constructor">WalkControl(<span class="hljs-params">tree</span>, <span class="hljs-params">includeTop</span>=False)</span>:<br>    <span class="hljs-keyword">if</span> not isinstance(item, auto.TreeItemControl):<br>        continue<br>    item.<span class="hljs-constructor">GetSelectionItemPattern()</span>.<span class="hljs-constructor">Select(<span class="hljs-params">waitTime</span>=0.01)</span><br>    pattern = item.<span class="hljs-constructor">GetExpandCollapsePattern()</span><br>    <span class="hljs-keyword">if</span> pattern.ExpandCollapseState<span class="hljs-operator"> == </span>auto.ExpandCollapseState.Collapsed:<br>        pattern.<span class="hljs-constructor">Expand(<span class="hljs-params">waitTime</span>=0.01)</span><br>    print(<span class="hljs-character">&#x27; &#x27;</span><span class="hljs-operator"> * </span>(depth - <span class="hljs-number">1</span>)<span class="hljs-operator"> * </span><span class="hljs-number">4</span>, item.Name)<br><span class="hljs-number">12345678</span><br></code></pre></td></tr></table></figure><p>部分结果：</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">DESKTOP</span><span class="hljs-operator">-</span><span class="hljs-variable">IS8QJHF</span><br>     <span class="hljs-variable">IDE</span> <span class="hljs-variable">ATA</span><span class="hljs-operator">/</span><span class="hljs-variable">ATAPI</span> 控制器<br>         <span class="hljs-variable">Intel</span><span class="hljs-punctuation">(</span><span class="hljs-variable">R</span><span class="hljs-punctuation">)</span> <span class="hljs-number">300</span> <span class="hljs-built_in">Series</span> <span class="hljs-variable">Chipset</span> <span class="hljs-variable">Family</span> <span class="hljs-variable">SATA</span> <span class="hljs-variable">AHCI</span> <span class="hljs-variable">Controller</span><br>     便携设备<br>         <span class="hljs-variable">Seagate1</span><span class="hljs-number">.81</span><span class="hljs-variable">TB</span><br>     <span class="hljs-operator">.....</span><br>     音频输入和输出<br>         <span class="hljs-number">24</span><span class="hljs-variable">B1W1G5</span> <span class="hljs-punctuation">(</span>英特尔<span class="hljs-punctuation">(</span><span class="hljs-variable">R</span><span class="hljs-punctuation">)</span> 显示器音频<span class="hljs-punctuation">)</span><br>         <span class="hljs-variable">Realtek</span> <span class="hljs-variable">Digital</span> <span class="hljs-variable">Output</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Realtek</span> <span class="hljs-variable">High</span> <span class="hljs-built_in">Definition</span> <span class="hljs-built_in">Audio</span><span class="hljs-punctuation">)</span><br>         立体声混音 <span class="hljs-punctuation">(</span><span class="hljs-variable">Realtek</span> <span class="hljs-variable">High</span> <span class="hljs-built_in">Definition</span> <span class="hljs-built_in">Audio</span><span class="hljs-punctuation">)</span><br>         扬声器 <span class="hljs-punctuation">(</span><span class="hljs-variable">Realtek</span> <span class="hljs-variable">High</span> <span class="hljs-built_in">Definition</span> <span class="hljs-built_in">Audio</span><span class="hljs-punctuation">)</span><br><span class="hljs-number">12345678910</span><br></code></pre></td></tr></table></figure><p>上述代码执行后，滚动条已经到底底部，下面我们可以执行以下代码让滚动条回到顶部：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">treeScrollPattern</span> = tree.GetScrollPattern()<br><span class="hljs-attribute">treeScrollPattern</span>.SetScrollPercent(-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>)<br><span class="hljs-attribute">1</span><br></code></pre></td></tr></table></figure><p>SetScrollPercent传入的两个参数表示将滚动条移动到指定百分比位置：</p><p>-</p><ul><li><p><strong>horizontalPercent</strong>: 横向位置百分比</p></li><li></li><li><p><strong>verticalPercent</strong>: 纵向位置百分比</p></li><li></li></ul><p>传入-1表示不移动，由于没有横向滚动条，所以第一个参数传入了-1。</p><p>当然也可以移动到底部：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">treeScrollPattern</span>.SetScrollPercent(-<span class="hljs-number">1</span>, <span class="hljs-number">100</span>)<br></code></pre></td></tr></table></figure><p>也可以使用鼠标滑轮实现：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 滚动条未到顶就使鼠标滑轮不停往上滑</span><br><span class="hljs-attribute">while</span> treeScrollPattern.VerticalScrollPercent &gt; <span class="hljs-number">0</span>:<br>    <span class="hljs-attribute">tree</span>.WheelUp(waitTime=<span class="hljs-number">0</span>.<span class="hljs-number">01</span>)<br><span class="hljs-comment"># 滚动条未到底就使鼠标滑轮不停往下滑</span><br><span class="hljs-attribute">while</span> treeScrollPattern.VerticalScrollPercent &lt; <span class="hljs-number">100</span>:<br>    <span class="hljs-attribute">tree</span>.WheelDown(waitTime=<span class="hljs-number">0</span>.<span class="hljs-number">01</span>)<br><span class="hljs-attribute">12345</span><br></code></pre></td></tr></table></figure><p>上述两个操作也可以直接通过快捷键实现：</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">tree.SendKeys(&#x27;</span><span class="hljs-template-variable">&#123;Ctrl&#125;</span><span class="hljs-template-variable">&#123;Home&#125;</span><span class="language-xml">&#x27;, waitTime = 1)</span><br><span class="language-xml">tree.SendKeys(&#x27;</span><span class="hljs-template-variable">&#123;Ctrl&#125;</span><span class="hljs-template-variable">&#123;End&#125;</span><span class="language-xml">&#x27;, waitTime = 1)</span><br><span class="language-xml">1</span><br></code></pre></td></tr></table></figure><p>前面我们在获取tree控件时，设备管理器并没有滚动条，展开控件后产生的滚动条。此时必须更新控件信息：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dos"><span class="hljs-built_in">print</span>(<span class="hljs-built_in">tree</span>.NativeWindowHandle, <span class="hljs-built_in">tree</span>.Element, len(<span class="hljs-built_in">tree</span>.GetChildren()))<br><span class="hljs-built_in">tree</span>.Refind()<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">tree</span>.NativeWindowHandle, <span class="hljs-built_in">tree</span>.Element, len(<span class="hljs-built_in">tree</span>.GetChildren()))<br><span class="hljs-number">12</span><br><span class="hljs-number">329304</span> &lt;POINTER(IUIAutomationElement) ptr=<span class="hljs-number">0</span>x1df11091f00 <span class="hljs-built_in">at</span> <span class="hljs-number">1</span>df1c7d14c8&gt; <span class="hljs-number">1</span><br><span class="hljs-number">329304</span> &lt;POINTER(IUIAutomationElement) ptr=<span class="hljs-number">0</span>x1df11092480 <span class="hljs-built_in">at</span> <span class="hljs-number">1</span>df1d889148&gt; <span class="hljs-number">2</span><br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>可以看到再重新查找控件后，控件信息发生变化。</p><p>下面我们直接拖拽滚动条来实现界面区域的变化，我们需要先知道windows的滚动条组件由三个按钮和一个缩略图组成，首先我们获取滚动条和其中的滑动块对象：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">vScrollBar = tree.ScrollBarControl(<span class="hljs-attribute">AutomationId</span>=<span class="hljs-string">&#x27;NonClientVerticalScrollBar&#x27;</span>)<br>thumb = vScrollBar.ThumbControl()<br>1<br></code></pre></td></tr></table></figure><p>然后移动鼠标到滑动块中心位置并获取位置坐标：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">x, y = thumb<span class="hljs-selector-class">.MoveCursorToMyCenter</span>()<br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(x, y)</span></span><br><span class="hljs-number">1</span><br><span class="hljs-number">941</span> <span class="hljs-number">663</span><br></code></pre></td></tr></table></figure><p>获取整个滚动条的坐标范围：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">vScrollBarRect = vScrollBar<span class="hljs-selector-class">.BoundingRectangle</span><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(vScrollBarRect, vScrollBarRect.top, vScrollBarRect.bottom)</span></span><br><span class="hljs-number">1</span><br>(<span class="hljs-number">933</span>,<span class="hljs-number">86</span>,<span class="hljs-number">950</span>,<span class="hljs-number">778</span>)<span class="hljs-selector-attr">[17x692]</span> <span class="hljs-number">86</span> <span class="hljs-number">778</span><br></code></pre></td></tr></table></figure><p>鼠标拖拽滑动条从底到顶：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">vScrollBar = tree.<span class="hljs-constructor">ScrollBarControl(AutomationId=&#x27;NonClientVerticalScrollBar&#x27;)</span><br>thumb = vScrollBar.<span class="hljs-constructor">ThumbControl()</span><br>x, y = thumb.<span class="hljs-constructor">MoveCursorToMyCenter()</span><br>vScrollBarRect = vScrollBar.BoundingRectangle<br>auto.<span class="hljs-constructor">DragDrop(<span class="hljs-params">x</span>, <span class="hljs-params">y</span>, <span class="hljs-params">x</span>, <span class="hljs-params">vScrollBarRect</span>.<span class="hljs-params">top</span>, <span class="hljs-params">waitTime</span>=1)</span><br><span class="hljs-number">1234</span><br></code></pre></td></tr></table></figure><p>从顶到底：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">x, y = thumb.<span class="hljs-constructor">MoveCursorToMyCenter()</span><br>auto.<span class="hljs-constructor">DragDrop(<span class="hljs-params">x</span>, <span class="hljs-params">y</span>, <span class="hljs-params">x</span>, <span class="hljs-params">vScrollBarRect</span>.<span class="hljs-params">bottom</span>, <span class="hljs-params">waitTime</span>=1)</span><br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>下面我们将上述方法整理到一个脚本中，假如我们需要管理员提权可以使用如下命令：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">auto.<span class="hljs-constructor">RunScriptAsAdmin(<span class="hljs-params">sys</span>.<span class="hljs-params">argv</span>)</span><br></code></pre></td></tr></table></figure><p>实际使用过程中需要使用如下命令判断是否已经具备管理员避免无限循环：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">auto<span class="hljs-selector-class">.IsUserAnAdmin</span>()<br></code></pre></td></tr></table></figure><p>完整代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">小小明的代码</span><br><span class="hljs-string">CSDN主页：https://blog.csdn.net/as604049322</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>__author__ = <span class="hljs-string">&#x27;小小明&#x27;</span><br>__time__ = <span class="hljs-string">&#x27;2021/11/12&#x27;</span><br><br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">import</span> uiautomation <span class="hljs-keyword">as</span> auto<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    sw, sh = auto.GetScreenSize()<br>    cmdWindow = auto.GetConsoleWindow()<br>    <span class="hljs-keyword">if</span> cmdWindow:<br>        cmdTransformPattern = cmdWindow.GetTransformPattern()<br>        cmdTransformPattern.Move(sw // <span class="hljs-number">4</span>, <span class="hljs-number">0</span>)<br>        cmdTransformPattern.Resize(sw // <span class="hljs-number">4</span>, sh * <span class="hljs-number">3</span> // <span class="hljs-number">5</span>)<br><br>    subprocess.Popen(<span class="hljs-string">&#x27;mmc.exe devmgmt.msc&#x27;</span>)<br>    mmcWindow = auto.WindowControl(searchDepth=<span class="hljs-number">1</span>, ClassName=<span class="hljs-string">&#x27;MMCMainFrame&#x27;</span>)<br>    mmcTransformPattern = mmcWindow.GetTransformPattern()<br>    mmcTransformPattern.Move(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>    mmcTransformPattern.Resize(sw // <span class="hljs-number">4</span>, sh * <span class="hljs-number">3</span> // <span class="hljs-number">5</span>)<br><br>    tree = mmcWindow.TreeControl()<br>    <span class="hljs-keyword">for</span> item, depth <span class="hljs-keyword">in</span> auto.WalkControl(tree, includeTop=<span class="hljs-literal">False</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(item, auto.TreeItemControl):<br>            <span class="hljs-keyword">continue</span><br>        item.GetSelectionItemPattern().Select(waitTime=<span class="hljs-number">0.01</span>)<br>        pattern = item.GetExpandCollapsePattern()<br>        <span class="hljs-keyword">if</span> pattern.ExpandCollapseState == auto.ExpandCollapseState.Collapsed:<br>            pattern.Expand(waitTime=<span class="hljs-number">0.01</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27; &#x27;</span> * (depth - <span class="hljs-number">1</span>) * <span class="hljs-number">4</span>, item.Name)<br><br>    tree = mmcWindow.TreeControl()<br>    treeScrollPattern = tree.GetScrollPattern()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ScrollPattern.SetScrollPercent(1, 0)&quot;</span>)<br>    treeScrollPattern.SetScrollPercent(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ScrollPattern.SetScrollPercent(1, 100)&quot;</span>)<br>    treeScrollPattern.SetScrollPercent(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>)<br><br>    treeScrollPattern = tree.GetScrollPattern()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;滚动条未到顶就使鼠标滑轮不停往上滑&quot;</span>)<br>    <span class="hljs-comment"># 滚动条未到顶就使鼠标滑轮不停往上滑</span><br>    <span class="hljs-keyword">while</span> treeScrollPattern.VerticalScrollPercent &gt; <span class="hljs-number">0</span>:<br>        tree.WheelUp(waitTime=<span class="hljs-number">0.01</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;滚动条未到底就使鼠标滑轮不停往下滑&quot;</span>)<br>    <span class="hljs-comment"># 滚动条未到底就使鼠标滑轮不停往下滑</span><br>    <span class="hljs-keyword">while</span> treeScrollPattern.VerticalScrollPercent &lt; <span class="hljs-number">100</span>:<br>        tree.WheelDown(waitTime=<span class="hljs-number">0.01</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;快捷键控制窗口滚动到顶&quot;</span>)<br>    tree.SendKeys(<span class="hljs-string">&#x27;&#123;Ctrl&#125;&#123;Home&#125;&#x27;</span>, waitTime=<span class="hljs-number">1</span>)<br>    time.sleep(<span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;快捷键控制窗口滚动到底&quot;</span>)<br>    tree.SendKeys(<span class="hljs-string">&#x27;&#123;Ctrl&#125;&#123;End&#125;&#x27;</span>, waitTime=<span class="hljs-number">1</span>)<br><br>    tree.Refind()<br><br>    vScrollBar = tree.ScrollBarControl(AutomationId=<span class="hljs-string">&#x27;NonClientVerticalScrollBar&#x27;</span>)<br>    thumb = vScrollBar.ThumbControl()<br>    vScrollBarRect = vScrollBar.BoundingRectangle<br>    x, y = thumb.MoveCursorToMyCenter()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;拖拽滚动条向上移动...&quot;</span>)<br>    auto.DragDrop(x, y, x, vScrollBarRect.top, waitTime=<span class="hljs-number">1</span>)<br>    x, y = thumb.MoveCursorToMyCenter()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;拖拽滚动条向下移动...&quot;</span>)<br>    auto.DragDrop(x, y, x, vScrollBarRect.bottom, waitTime=<span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;关闭设备管理器&quot;</span>)<br>    mmcWindow.GetWindowPattern().Close()<br>    <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;已经运行完毕，回车结束&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> auto.IsUserAnAdmin():<br>        main()<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;RunScriptAsAdmin&#x27;</span>, sys.executable, sys.argv)<br>        auto.RunScriptAsAdmin(sys.argv)<br><span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869</span><br></code></pre></td></tr></table></figure><p>运行过程：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_19.gif" srcset="/img/loading.gif" lazyload alt="请添加图片描述"></p><h2 id="记事本文本输入与字体调整"><a href="#记事本文本输入与字体调整" class="headerlink" title="记事本文本输入与字体调整"></a>记事本文本输入与字体调整</h2><p>首先打开记事本窗口，调整大小激活并置顶：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">import uiautomation as auto<br>import subprocess<br><span class="hljs-comment"># 设置全局搜索超时时间为1秒</span><br>auto.uiautomation.SetGlobalSearchTimeout(<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># 查找notepad</span><br>note = auto.WindowControl(<br>    searchDepth=<span class="hljs-number">1</span>, ClassName=<span class="hljs-string">&#x27;Notepad&#x27;</span>, RegexName=<span class="hljs-string">&#x27;.* - 记事本&#x27;</span>)<br><span class="hljs-keyword">if</span> not auto.WaitForExist(note, <span class="hljs-number">0.1</span>):<br>    subprocess.Popen(<span class="hljs-string">&#x27;notepad&#x27;</span>)<br>sw, sh = auto.GetScreenSize()<br>note.MoveWindow(sw <span class="hljs-regexp">//</span> <span class="hljs-number">10</span>, sh <span class="hljs-regexp">//</span> <span class="hljs-number">10</span>, sw <span class="hljs-regexp">//</span> <span class="hljs-number">2</span>, sh <span class="hljs-regexp">//</span> <span class="hljs-number">2</span>)<br>note.SetActive()<br>note.SetTopmost()<br><span class="hljs-number">123456789101112</span><br></code></pre></td></tr></table></figure><p>下面我们测试一下文本输入：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs vim">text = <span class="hljs-string">&quot;&quot;</span><span class="hljs-comment">&quot;Windows中GUI自动化的三种技术：Windows API, MSAA - Microsoft Active Accessibility, UIAutomation</span><br>用脚本语言AutoIT实现自动化就是第一种技术Windows API, 查找窗口句柄实现的。<br>用工具Spy++查看程序，如果Spy++能识别程序窗口中的控件就能用这种技术。<br><span class="hljs-keyword">python</span>的UI自动化测试模块 pywinauto，也是用这种技术实现的(现在pywinauto也支持UIAutomation了)。 <br>但Windows API实现的自动化不支持WPF程序、Windows <span class="hljs-number">8</span>中的Metro程序，因为它们的控件都是自绘出来的，没有句柄的概念。<br>用UIAutomation实现的自动化支持微软提供的各种界面开发框架，如Win32, MFC, Windows Forms, WPF, Metro App, IE。<br>Qt, Firefox, Chrome实现了UI Automation Provider，也支持UIAutomation.<br><br>tip:<br>Win10系统下应该使用<span class="hljs-number">64</span>位Python运行本程序，<span class="hljs-number">32</span>位进程无法正确获取一些控件的边界坐标。<br>详见：https://github.<span class="hljs-keyword">com</span>/microsoft/accessibility-insights-windows/issues/<span class="hljs-number">1122</span><br><span class="hljs-string">&quot;&quot;</span><span class="hljs-comment">&quot;</span><br><span class="hljs-keyword">edit</span> = note.EditControl()<br><span class="hljs-keyword">edit</span>.Click(waitTime=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">edit</span>.GetValuePattern().SetValue(<span class="hljs-string">&#x27;你好&#x27;</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;&#123;Ctrl&#125;&#123;End&#125;&#123;Enter&#125;下面开始演示&#123;! 4&#125;&#123;ENTER&#125;&#x27;</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(text)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;&#123;Enter 3&#125;0123456789&#123;Enter&#125;&#x27;</span>, waitTime=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#123;ENTER&#125;&#x27;</span>, waitTime=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyz&#123;ENTER&#125;&#x27;</span>, waitTime=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;`~!@#$%^&amp;*()-_=+&#123;ENTER&#125;&#x27;</span>, waitTime=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;[]&#123;&#123;&#125;&#123;&#125;&#125;\\|;:\&#x27;</span>\<span class="hljs-comment">&quot;,&lt;.&gt;/?&#123;ENTER&#125;&#x27;, waitTime=0)</span><br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;™®①②③④⑤⑥⑦⑧⑨⑩§№☆★○●◎◇◆□℃‰€■△▲※→←↑↓〓¤°＃＆＠＼＾＿―♂♀&#x27;</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&quot;&#123;ENTER&#125;&#123;CTRL&#125;a&quot;</span>)<br>note.CaptureToImage(<span class="hljs-string">&#x27;Notepad.png&#x27;</span>)<br><span class="hljs-number">1234567891011121314151617181920212223</span><br></code></pre></td></tr></table></figure><p>其中SendKeys的参数为：control.SendKeys(text: str, interval: float &#x3D; 0.01,waitTime: float &#x3D; 0.5, charMode: bool &#x3D; True)</p><p>interval参数决定了输入的间隔，修改这个参数为0.2减慢了输入的频率更像打字机的效果。</p><p>最终产生的截图为：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_20.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211113143004093"></p><p>下面我们修改一下字体相关信息：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 查找菜单</span><br>note.MenuItemControl(<span class="hljs-attribute">Name</span>=<span class="hljs-string">&#x27;格式(O)&#x27;</span>).Click()<br>note.MenuItemControl(<span class="hljs-attribute">Name</span>=<span class="hljs-string">&#x27;字体(F)...&#x27;</span>).Click()<br>windowFont = note.WindowControl(<span class="hljs-attribute">Name</span>=<span class="hljs-string">&#x27;字体&#x27;</span>)<br>font_data = &#123;<span class="hljs-string">&quot;字体(F):&quot;</span>: <span class="hljs-string">&quot;微软雅黑&quot;</span>, <span class="hljs-string">&quot;字形(Y):&quot;</span>: <span class="hljs-string">&quot;常规&quot;</span>, <span class="hljs-string">&quot;大小(S):&quot;</span>: <span class="hljs-string">&quot;小四&quot;</span>&#125;<br><span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> font_data.items():<br>    listItem = windowFont.ListControl(<br>        <span class="hljs-attribute">searchDepth</span>=2, <span class="hljs-attribute">AutomationId</span>=<span class="hljs-string">&#x27;1000&#x27;</span>, <span class="hljs-attribute">Name</span>=k).ListItemControl(Name=v)<br>    <span class="hljs-keyword">if</span> listItem.Exists(1):<br>        listItem.GetScrollItemPattern().ScrollIntoView()<br>        listItem.Click()<br>12345678910<br></code></pre></td></tr></table></figure><p>其中ScrollIntoView()方法滚动目标到可见区域。</p><p>可以通过以下方面打印字体列表中的所有可选字体：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs routeros">font_ListControl = windowFont.ListControl(<br>    <span class="hljs-attribute">searchDepth</span>=2, <span class="hljs-attribute">AutomationId</span>=<span class="hljs-string">&#x27;1000&#x27;</span>, <span class="hljs-attribute">Name</span>=<span class="hljs-string">&quot;字体(F):&quot;</span>)<br><span class="hljs-keyword">for</span> item, depth <span class="hljs-keyword">in</span> auto.WalkControl(font_ListControl, <span class="hljs-attribute">includeTop</span>=<span class="hljs-literal">True</span>, <span class="hljs-attribute">maxDepth</span>=2):<br>    <span class="hljs-keyword">if</span> depth != 1 <span class="hljs-keyword">or</span> item.ControlType != auto.ControlType.ListItemControl:<br>        continue<br>    <span class="hljs-built_in">print</span>(item.Name)<br>12345<br>Agency FB<br>Algerian<br>Arial<br><span class="hljs-built_in">..</span>.<br>微软雅黑<br>新宋体<br>幼圆<br>123456<br></code></pre></td></tr></table></figure><p>对于需要展开的项目则需要先展开下拉列表，例如打印所有的脚本项：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs stylus">windowFont<span class="hljs-selector-class">.SetActive</span>()<br>combo = windowFont<span class="hljs-selector-class">.ComboBoxControl</span>(AutomationId=<span class="hljs-string">&#x27;1140&#x27;</span>)<br>pattern = combo<span class="hljs-selector-class">.GetExpandCollapsePattern</span>()<br><span class="hljs-keyword">if</span> pattern<span class="hljs-selector-class">.ExpandCollapseState</span> == auto<span class="hljs-selector-class">.ExpandCollapseState</span><span class="hljs-selector-class">.Collapsed</span>:<br>    pattern<span class="hljs-selector-class">.Expand</span>(waitTime=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">for</span> item, depth <span class="hljs-keyword">in</span> auto<span class="hljs-selector-class">.WalkControl</span>(combo, includeTop=True, maxDepth=<span class="hljs-number">2</span>):<br>    <span class="hljs-keyword">if</span> depth != <span class="hljs-number">2</span> or item<span class="hljs-selector-class">.ControlType</span> != auto<span class="hljs-selector-class">.ControlType</span><span class="hljs-selector-class">.ListItemControl</span>:<br>        continue<br>    <span class="hljs-built_in">print</span>(item.Name)<br><span class="hljs-number">12345678</span><br>中文 GB2312<br>西欧语言<br>希腊语<br>土耳其语<br>中欧字符<br>西里尔文<br><span class="hljs-number">12345</span><br></code></pre></td></tr></table></figure><p>我们选择中文类型的脚本：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">combo.Select(&#x27;中文 GB<span class="hljs-number">2312</span>&#x27;)<br></code></pre></td></tr></table></figure><p>最后点击确定按钮：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">windowFont.ButtonControl(<span class="hljs-attribute">Name</span>=<span class="hljs-string">&#x27;确定&#x27;</span>).Click()<br></code></pre></td></tr></table></figure><p><strong>完整代码：</strong></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs vim">import uiautomation <span class="hljs-keyword">as</span> auto<br>import subprocess<br># 设置全局搜索超时时间为<span class="hljs-number">1</span>秒<br>auto.uiautomation.SetGlobalSearchTimeout(<span class="hljs-number">1</span>)<br><br># 查找notepad<br>note = auto.WindowControl(<br>    searchDepth=<span class="hljs-number">1</span>, ClassName=<span class="hljs-string">&#x27;Notepad&#x27;</span>, RegexName=<span class="hljs-string">&#x27;.* - 记事本&#x27;</span>)<br><span class="hljs-keyword">if</span> not auto.WaitForExist(note, <span class="hljs-number">0.1</span>):<br>    subprocess.Popen(<span class="hljs-string">&#x27;notepad&#x27;</span>)<br><span class="hljs-keyword">sw</span>, <span class="hljs-keyword">sh</span> = auto.GetScreenSize()<br>note.MoveWindow(<span class="hljs-keyword">sw</span> // <span class="hljs-number">10</span>, <span class="hljs-keyword">sh</span> // <span class="hljs-number">10</span>, <span class="hljs-keyword">sw</span> // <span class="hljs-number">2</span>, <span class="hljs-keyword">sh</span> // <span class="hljs-number">2</span>)<br>note.SetActive()<br>note.SetTopmost()<br>text = <span class="hljs-string">&quot;&quot;</span><span class="hljs-comment">&quot;Windows中GUI自动化的三种技术：Windows API, MSAA - Microsoft Active Accessibility, UIAutomation</span><br>用脚本语言AutoIT实现自动化就是第一种技术Windows API, 查找窗口句柄实现的。<br>用工具Spy++查看程序，如果Spy++能识别程序窗口中的控件就能用这种技术。<br><span class="hljs-keyword">python</span>的UI自动化测试模块 pywinauto，也是用这种技术实现的(现在pywinauto也支持UIAutomation了)。 <br>但Windows API实现的自动化不支持WPF程序、Windows <span class="hljs-number">8</span>中的Metro程序，因为它们的控件都是自绘出来的，没有句柄的概念。<br>用UIAutomation实现的自动化支持微软提供的各种界面开发框架，如Win32, MFC, Windows Forms, WPF, Metro App, IE。<br>Qt, Firefox, Chrome实现了UI Automation Provider，也支持UIAutomation.<br><br>tip:<br>Win10系统下应该使用<span class="hljs-number">64</span>位Python运行本程序，<span class="hljs-number">32</span>位进程无法正确获取一些控件的边界坐标。<br>详见：https://github.<span class="hljs-keyword">com</span>/microsoft/accessibility-insights-windows/issues/<span class="hljs-number">1122</span><br><span class="hljs-string">&quot;&quot;</span><span class="hljs-comment">&quot;</span><br><span class="hljs-keyword">edit</span> = note.EditControl()<br><span class="hljs-keyword">edit</span>.Click(waitTime=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">edit</span>.GetValuePattern().SetValue(<span class="hljs-string">&#x27;你好&#x27;</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;&#123;Ctrl&#125;&#123;End&#125;&#123;Enter&#125;下面开始演示&#123;! 4&#125;&#123;ENTER&#125;&#x27;</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(text)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;&#123;Enter 3&#125;0123456789&#123;Enter&#125;&#x27;</span>, waitTime=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#123;ENTER&#125;&#x27;</span>, waitTime=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyz&#123;ENTER&#125;&#x27;</span>, waitTime=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;`~!@#$%^&amp;*()-_=+&#123;ENTER&#125;&#x27;</span>, waitTime=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;[]&#123;&#123;&#125;&#123;&#125;&#125;\\|;:\&#x27;</span>\<span class="hljs-comment">&quot;,&lt;.&gt;/?&#123;ENTER&#125;&#x27;, waitTime=0)</span><br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&#x27;™®①②③④⑤⑥⑦⑧⑨⑩§№☆★○●◎◇◆□℃‰€■△▲※→←↑↓〓¤°＃＆＠＼＾＿―♂♀&#x27;</span>)<br><span class="hljs-keyword">edit</span>.SendKeys(<span class="hljs-string">&quot;&#123;ENTER&#125;&#123;CTRL&#125;a&quot;</span>)<br>note.CaptureToImage(<span class="hljs-string">&#x27;Notepad.png&#x27;</span>)<br># 查找菜单<br>note.MenuItemControl(Name=<span class="hljs-string">&#x27;格式(O)&#x27;</span>).Click()<br>note.MenuItemControl(Name=<span class="hljs-string">&#x27;字体(F)...&#x27;</span>).Click()<br>windowFont = note.WindowControl(Name=<span class="hljs-string">&#x27;字体&#x27;</span>)<br>font_data = &#123;<span class="hljs-string">&quot;字体(F):&quot;</span>: <span class="hljs-string">&quot;微软雅黑&quot;</span>, <span class="hljs-string">&quot;字形(Y):&quot;</span>: <span class="hljs-string">&quot;常规&quot;</span>, <span class="hljs-string">&quot;大小(S):&quot;</span>: <span class="hljs-string">&quot;小四&quot;</span>&#125;<br><span class="hljs-keyword">for</span> <span class="hljs-keyword">k</span>, v in font_data.<span class="hljs-built_in">items</span>():<br>    listItem = windowFont.ListControl(<br>        searchDepth=<span class="hljs-number">2</span>, AutomationId=<span class="hljs-string">&#x27;1000&#x27;</span>, Name=<span class="hljs-keyword">k</span>).ListItemControl(Name=v)<br>    <span class="hljs-keyword">if</span> listItem.Exists(<span class="hljs-number">1</span>):<br>        listItem.GetScrollItemPattern().ScrollIntoView()<br>        listItem.Click()<br>windowFont.SetActive()<br>combo = windowFont.ComboBoxControl(AutomationId=<span class="hljs-string">&#x27;1140&#x27;</span>)<br>combo.Select(<span class="hljs-string">&#x27;中文 GB2312&#x27;</span>)<br>windowFont.ButtonControl(Name=<span class="hljs-string">&#x27;确定&#x27;</span>).Click()<br>note.SetTopmost(False)<br>subprocess.Popen(<span class="hljs-string">&#x27;Notepad.png&#x27;</span>, <span class="hljs-keyword">shell</span>=True)<br><span class="hljs-number">1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253</span><br></code></pre></td></tr></table></figure><p>执行结果：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_21.gif" srcset="/img/loading.gif" lazyload alt="请添加图片描述"></p><h2 id="wireshark抓包数据读取"><a href="#wireshark抓包数据读取" class="headerlink" title="wireshark抓包数据读取"></a>wireshark抓包数据读取</h2><p>下面我们演示如何保存wireshark抓包到的数据。首先我们需要自行打开wireshark程序后进行抓包。抓包几秒钟后有了如下结果：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_22.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211113172346882"></p><p>下面我们的目标是保存这个表格的数据。</p><p>首先我们需要获取wireshark的窗口对象，经过inspect工具的检查，ClassName和AutomationId均为MainWindow：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_23.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211113170212787"></p><p>这个对象的Name属性与窗口标题一致会根据状态不断变化，所以不能作为一个查找项，正常情况在能够保证开的窗口很少的情况下，我们可以通过如下简单的代码获取到wireshark的窗口对象：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">win = auto.WindowControl(<br>    <span class="hljs-attribute">searchDepth</span>=1, <span class="hljs-attribute">ClassName</span>=<span class="hljs-string">&#x27;MainWindow&#x27;</span>, <span class="hljs-attribute">AutomationId</span>=<span class="hljs-string">&#x27;MainWindow&#x27;</span>)<br>1<br></code></pre></td></tr></table></figure><p>但是ClassName值为MainWindow的窗口实在太多了，我们无法确认时就需要其他方法来查找窗口，否则可能找到的窗口并不是wireshark。</p><p>但是wireshark有个过滤选择器工具栏的AutomationId为”MainWindow.displayFilterToolBar”：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_24.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211113171242405"></p><p>我们可以以此为唯一标识找出wireshark窗口对象。</p><p>思路：从桌面根对象下面开始遍历每个窗口对象，判断它是否存在AutomationId为”MainWindow.displayFilterToolBar”的工具栏，找到即可返回，具体编码：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs scss">import uiautomation as auto<br>import <span class="hljs-selector-tag">time</span><br># 设置全局搜索超时时间为<span class="hljs-number">1</span>秒<br>auto<span class="hljs-selector-class">.uiautomation</span><span class="hljs-selector-class">.SetGlobalSearchTimeout</span>(<span class="hljs-number">1</span>)<br><br>def <span class="hljs-built_in">find_wiresharkWindow</span>():<br>    for win in auto.<span class="hljs-built_in">GetRootControl</span>().<span class="hljs-built_in">GetChildren</span>():<br>        if win.ClassName != <span class="hljs-string">&#x27;MainWindow&#x27;</span> or win.AutomationId != <span class="hljs-string">&#x27;MainWindow&#x27;</span>:<br>            continue<br>        if win.<span class="hljs-built_in">ToolBarControl</span>(AutomationId=<span class="hljs-string">&#x27;MainWindow.displayFilterToolBar&#x27;</span>).<span class="hljs-built_in">Exists</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>):<br>            return win<br><span class="hljs-number">123456789</span><br></code></pre></td></tr></table></figure><p>然后我们在获取到窗口后，调整一下窗口位置：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">wiresharkWindow = find<span class="hljs-constructor">_wiresharkWindow()</span><br>sw, sh = auto.<span class="hljs-constructor">GetScreenSize()</span><br>wiresharkWindow.<span class="hljs-constructor">MoveWindow(10, 10, <span class="hljs-params">sw</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 2, <span class="hljs-params">sh</span> <span class="hljs-operator">*</span> 3 <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 5)</span><br>wiresharkWindow.<span class="hljs-constructor">SetActive(<span class="hljs-params">waitTime</span>=0.1)</span><br>wiresharkWindow.<span class="hljs-constructor">SetTopmost()</span><br><span class="hljs-number">1234</span><br></code></pre></td></tr></table></figure><p>然后可以开始遍历树控件获取数据：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;按下F12可中止程序遍历&quot;</span>)<br>tree = wiresharkWindow.TreeControl(<br>    <span class="hljs-attribute">searchDepth</span>=4, <span class="hljs-attribute">ClassName</span>=<span class="hljs-string">&#x27;PacketList&#x27;</span>, <span class="hljs-attribute">Name</span>=<span class="hljs-string">&#x27;Packet list&#x27;</span>)<br>rect = tree.BoundingRectangle<br>tree.Click(<span class="hljs-attribute">y</span>=50, <span class="hljs-attribute">waitTime</span>=0.1)<br>auto.SendKeys(<span class="hljs-string">&#x27;&#123;Home&#125;&#x27;</span>, <span class="hljs-attribute">waitTime</span>=0.1)<br>treeItemCount = 0<br>columnCount = 0<br><span class="hljs-keyword">for</span> item, depth <span class="hljs-keyword">in</span> auto.WalkControl(tree):<br>    <span class="hljs-keyword">if</span> isinstance(item, auto.HeaderControl):<br>        <span class="hljs-built_in">print</span>(item.Name, <span class="hljs-attribute">end</span>=<span class="hljs-string">&quot; &quot;</span>)<br>        columnCount += 1<br>    elif isinstance(item, auto.TreeItemControl):<br>        <span class="hljs-keyword">if</span> treeItemCount % columnCount == 0:<br>            <span class="hljs-built_in">print</span>()<br>        treeItemCount += 1<br>        <span class="hljs-built_in">print</span>(item.Name, <span class="hljs-attribute">end</span>=<span class="hljs-string">&quot; &quot;</span>)<br>        <span class="hljs-keyword">if</span> item.BoundingRectangle.bottom &gt;= rect.bottom:<br>            auto.SendKeys(<span class="hljs-string">&#x27;&#123;PageDown&#125;&#x27;</span>, <span class="hljs-attribute">waitTime</span>=0.1)<br>    <span class="hljs-keyword">if</span> auto.IsKeyPressed(auto.Keys.VK_F12):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;F12已被按下，停止采集&quot;</span>)<br>        break<br>123456789101112131415161718192021<br></code></pre></td></tr></table></figure><p>为了避免程序持续无休止的运行，增加快捷键判断，循环中发现某个快捷键被按下则退出循环。可以看到打印结果很完美：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_25.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211113173852600"></p><p>下面我们重新组织一下代码，使结果最终能保存为pandas的datafream对象，<strong>完整代码如下：</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs scss">import pandas as pd<br>import uiautomation as auto<br><br># 设置全局搜索超时时间为<span class="hljs-number">1</span>秒<br>auto<span class="hljs-selector-class">.uiautomation</span><span class="hljs-selector-class">.SetGlobalSearchTimeout</span>(<span class="hljs-number">1</span>)<br><br><br>def <span class="hljs-built_in">find_wiresharkWindow</span>():<br>    for win in auto.<span class="hljs-built_in">GetRootControl</span>().<span class="hljs-built_in">GetChildren</span>():<br>        if win.ClassName != <span class="hljs-string">&#x27;MainWindow&#x27;</span> or win.AutomationId != <span class="hljs-string">&#x27;MainWindow&#x27;</span>:<br>            continue<br>        if win.<span class="hljs-built_in">ToolBarControl</span>(AutomationId=<span class="hljs-string">&#x27;MainWindow.displayFilterToolBar&#x27;</span>).<span class="hljs-built_in">Exists</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>):<br>            return win<br><br><br>wiresharkWindow = <span class="hljs-built_in">find_wiresharkWindow</span>()<br>sw, sh = auto.<span class="hljs-built_in">GetScreenSize</span>()<br>wiresharkWindow.<span class="hljs-built_in">MoveWindow</span>(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, sw // <span class="hljs-number">2</span>, sh * <span class="hljs-number">3</span> // <span class="hljs-number">5</span>)<br>wiresharkWindow.<span class="hljs-built_in">SetActive</span>(waitTime=<span class="hljs-number">0.1</span>)<br>wiresharkWindow.<span class="hljs-built_in">SetTopmost</span>()<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;按下F12可中止程序遍历&quot;</span>)<br>tree = wiresharkWindow.<span class="hljs-built_in">TreeControl</span>(<br>    searchDepth=<span class="hljs-number">4</span>, ClassName=<span class="hljs-string">&#x27;PacketList&#x27;</span>, Name=<span class="hljs-string">&#x27;Packet list&#x27;</span>)<br>rect = tree.BoundingRectangle<br>tree.<span class="hljs-built_in">Click</span>(y=<span class="hljs-number">50</span>, waitTime=<span class="hljs-number">0.1</span>)<br>auto.<span class="hljs-built_in">SendKeys</span>(<span class="hljs-string">&#x27;&#123;Home&#125;&#x27;</span>, waitTime=<span class="hljs-number">0.1</span>)<br>treeItemCount = <span class="hljs-number">0</span><br>columnCount = <span class="hljs-number">0</span><br>header = []<br>data, row = [], []<br>for item, depth in auto.<span class="hljs-built_in">WalkControl</span>(tree):<br>    if <span class="hljs-built_in">isinstance</span>(item, auto.HeaderControl):<br>        header.<span class="hljs-built_in">append</span>(item.Name)<br>        columnCount += <span class="hljs-number">1</span><br>    elif <span class="hljs-built_in">isinstance</span>(item, auto.TreeItemControl):<br>        if row and treeItemCount % columnCount == <span class="hljs-number">0</span>:<br>            data.<span class="hljs-built_in">append</span>(row)<br>            row = []<br>        treeItemCount += <span class="hljs-number">1</span><br>        row.<span class="hljs-built_in">append</span>(item.Name)<br>        if item.BoundingRectangle.bottom &gt;= rect.bottom:<br>            auto.<span class="hljs-built_in">SendKeys</span>(<span class="hljs-string">&#x27;&#123;PageDown&#125;&#x27;</span>, waitTime=<span class="hljs-number">0.1</span>)<br>    if auto.<span class="hljs-built_in">IsKeyPressed</span>(auto.Keys.VK_F12):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;F12已被按下，停止采集&quot;</span>)<br>        break<br>wiresharkWindow.<span class="hljs-built_in">SetTopmost</span>(False)<br>if row:<br>    data.<span class="hljs-built_in">append</span>(row)<br>df = pd.<span class="hljs-built_in">DataFrame</span>(data, columns=header)<br>df<br><span class="hljs-number">1234567891011121314151617181920212223242526272829303132333435363738394041424344</span><br></code></pre></td></tr></table></figure><p>结果：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_26.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211113180144045"></p><h2 id="PDF目录折叠展开提取器"><a href="#PDF目录折叠展开提取器" class="headerlink" title="PDF目录折叠展开提取器"></a>PDF目录折叠展开提取器</h2><p>本例计划开发一个针对树形控件的折叠展开工具，计划开发三个热键功能：</p><p>-</p><ul><li><p>递归展开某树形控件</p></li><li></li><li><p>递归折叠某树形控件</p></li><li></li><li><p>递归提取整棵树的文本</p></li><li></li></ul><p>当我们按某个快捷键时，则会自动定位当前鼠标下的控件，是树形控件时就会进行对应的操作。针对递归提取整棵树的文本，鼠标放到一个树形控件的任意位置，都会自动定位当前树的祖先控件。</p><p>下面针对这三个功能注册热键为Ctrl+1，Ctrl+2，Ctrl+3。最终完整代码为：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">import</span> uiautomation as <span class="hljs-built_in">auto</span><br><br><br>def ExpandTreeItem(stopEvent):<br>    with <span class="hljs-built_in">auto</span>.UIAutomationInitializerInThread():<br>        tree = <span class="hljs-built_in">auto</span>.ControlFromCursor()<br>        <span class="hljs-keyword">if</span> tree.ControlType <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-built_in">auto</span>.ControlType.TreeControl, <span class="hljs-built_in">auto</span>.ControlType.TreeItemControl]:<br>            <span class="hljs-keyword">return</span><br>        <span class="hljs-keyword">for</span> item, depth <span class="hljs-keyword">in</span> <span class="hljs-built_in">auto</span>.WalkControl(tree, includeTop=True):<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isinstance(item, <span class="hljs-built_in">auto</span>.TreeItemControl):<br>                <span class="hljs-keyword">continue</span><br>            ecpt = item.GetExpandCollapsePattern()<br>            <span class="hljs-keyword">if</span> ecpt <span class="hljs-keyword">and</span> ecpt.ExpandCollapseState == <span class="hljs-built_in">auto</span>.ExpandCollapseState.Collapsed:<br>                sipt = item.GetScrollItemPattern()<br>                <span class="hljs-keyword">if</span> sipt:<br>                    sipt.ScrollIntoView(waitTime=<span class="hljs-number">0.01</span>)<br>                ecpt.Expand(waitTime=<span class="hljs-number">0.01</span>)<br>        sipt = tree.GetScrollItemPattern()<br>        <span class="hljs-keyword">if</span> sipt:<br>            sipt.ScrollIntoView(waitTime=<span class="hljs-number">0.01</span>)<br><br><br>def copy_pdf_catalog(stopEvent):<br>    result = []<br>    with <span class="hljs-built_in">auto</span>.UIAutomationInitializerInThread():<br>        tree = <span class="hljs-built_in">auto</span>.ControlFromCursor()<br>        <span class="hljs-keyword">if</span> tree.ControlType <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-built_in">auto</span>.ControlType.TreeControl, <span class="hljs-built_in">auto</span>.ControlType.TreeItemControl]:<br>            <span class="hljs-keyword">return</span><br>        tree = tree.GetAncestorControl(lambda c, d: isinstance(c, <span class="hljs-built_in">auto</span>.TreeControl))<br>        <span class="hljs-keyword">for</span> item, depth <span class="hljs-keyword">in</span> <span class="hljs-built_in">auto</span>.WalkControl(tree, includeTop=True):<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isinstance(item, <span class="hljs-built_in">auto</span>.TreeItemControl):<br>                <span class="hljs-keyword">continue</span><br>            name = item.Name<br>            <span class="hljs-keyword">if</span> name:<br>                print(<span class="hljs-string">&quot;\t&quot;</span> * (depth - <span class="hljs-number">1</span>) + name)<br>                result.append(<span class="hljs-string">&quot;\t&quot;</span> * (depth - <span class="hljs-number">1</span>) + name)<br>            ecpt = item.GetExpandCollapsePattern()<br>            <span class="hljs-keyword">if</span> ecpt <span class="hljs-keyword">and</span> ecpt.ExpandCollapseState == <span class="hljs-built_in">auto</span>.ExpandCollapseState.Collapsed:<br>                sipt = item.GetScrollItemPattern()<br>                <span class="hljs-keyword">if</span> sipt:<br>                    sipt.ScrollIntoView(waitTime=<span class="hljs-number">0.01</span>)<br>                ecpt.Expand(waitTime=<span class="hljs-number">0.01</span>)<br>    text = <span class="hljs-string">&quot;\n&quot;</span>.join(result)<br>    <span class="hljs-built_in">auto</span>.SetClipboardText(text)<br><br><br>def CollapseTreeItem_recursion(treeItem: <span class="hljs-built_in">auto</span>.TreeItemControl):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isinstance(treeItem, <span class="hljs-built_in">auto</span>.TreeItemControl):<br>        <span class="hljs-keyword">return</span><br>    children = treeItem.GetChildren()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> children:<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">for</span> it <span class="hljs-keyword">in</span> children:<br>        CollapseTreeItem_recursion(it)<br>    ecpt = treeItem.GetExpandCollapsePattern()<br>    <span class="hljs-keyword">if</span> ecpt <span class="hljs-keyword">and</span> ecpt.ExpandCollapseState == <span class="hljs-built_in">auto</span>.ExpandCollapseState.Expanded:<br>        ecpt.Collapse(waitTime=<span class="hljs-number">0.05</span>)<br><br><br>def collapseTreeItem(stopEvent):<br>    with <span class="hljs-built_in">auto</span>.UIAutomationInitializerInThread():<br>        treeItem = <span class="hljs-built_in">auto</span>.ControlFromCursor()<br>        CollapseTreeItem_recursion(treeItem)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-built_in">auto</span>.RunByHotKey(&#123;<br>        (<span class="hljs-built_in">auto</span>.ModifierKey.Control, <span class="hljs-built_in">auto</span>.Keys.VK_1): collapseTreeItem,<br>        (<span class="hljs-built_in">auto</span>.ModifierKey.Control, <span class="hljs-built_in">auto</span>.Keys.VK_2): ExpandTreeItem,<br>        (<span class="hljs-built_in">auto</span>.ModifierKey.Control, <span class="hljs-built_in">auto</span>.Keys.VK_3): copy_pdf_catalog,<br>    &#125;, waitHotKeyReleased=False)<br><span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960</span><br></code></pre></td></tr></table></figure><p>经测试对极速PDF的目录完全有效，我们可以用来递归折叠或展开PDF的目录，或者直接从UI提取目录的内容。</p><p>运行后程序显示：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">Register hotkey (<span class="hljs-string">&#x27;Control&#x27;</span>, <span class="hljs-string">&#x27;VK_1&#x27;</span>) successfully<br>Register hotkey (<span class="hljs-string">&#x27;Control&#x27;</span>, <span class="hljs-string">&#x27;VK_2&#x27;</span>) successfully<br>Register hotkey (<span class="hljs-string">&#x27;Control&#x27;</span>, <span class="hljs-string">&#x27;VK_3&#x27;</span>) successfully<br>Register <span class="hljs-keyword">exit</span> hotkey (<span class="hljs-string">&#x27;Control&#x27;</span>, <span class="hljs-string">&#x27;VK_D&#x27;</span>) successfully<br><span class="hljs-number">123</span><br></code></pre></td></tr></table></figure><p>先按下Ctrl+1测试一下折叠功能（录屏软件挡住时无法获取到鼠标下的控件，所以用手机录）：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_27.gif" srcset="/img/loading.gif" lazyload alt="请添加图片描述"></p><p>按下Ctrl+2则非常顺利的进行了相应的反向操作，大家可以自己感受一下。</p><p>按下Ctrl+3，执行完毕后，我将剪切板中的内容粘贴到记事本：</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/2021/2021-11/2021-11-19/d6acb36960f64c9b98babcf538797296_28.png?x-oss-process=style/watermark" srcset="/img/loading.gif" lazyload alt="image-20211118004639754"></p><p>可以看到已经完美提取出PDF的目录，该复制到剪切板中的目录还可以直接粘贴到思维导图中。</p><blockquote><p>原文: <a target="_blank" rel="noopener" href="https://blog.csdn.net/as604049322/article/details/121391639">https://blog.csdn.net/as604049322/article/details/121391639</a></p></blockquote><p>发表评论</p><p>暂无评论</p><p><a target="_blank" rel="noopener" href="https://www.daima.net/tjk"><img src="https://daimanet.oss-cn-beijing.aliyuncs.com//2022/2022-01/2022-01-16/daimanet.jpg?x-oss-process=style/HEADER" srcset="/img/loading.gif" lazyload alt="img">tjk</a></p><p>关注</p><p>170</p><p>0</p><p>0</p><p>浏览量</p><p>粉丝</p><p>关注</p><p><img src="https://daimanet.oss-cn-beijing.aliyuncs.com/index/logo.jpg?x-oss-process=style/HEADER" srcset="/img/loading.gif" lazyload alt="img"></p><p>友情链接: <a target="_blank" rel="noopener" href="https://www.daima.net/">代码网</a> <a target="_blank" rel="noopener" href="https://suowo.cn/">短链接</a> <a target="_blank" rel="noopener" href="http://www.fzvps.com/">飞纵云</a></p><p><a target="_blank" rel="noopener" href="https://www.daima.net/">Copyright©代码网 2003 - 2020</a> <a target="_blank" rel="noopener" href="https://www.daima.net/help?type=1">免责声明</a> <a target="_blank" rel="noopener" href="https://www.daima.net/help?type=2">侵权联系</a> <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">陕ICP备2021014434号-1</a></p><p>set 限制解除</p><p><img src="chrome-extension:/golkpggaiebgepbccjaoifgeeemiacoo/images/logo_64.png" srcset="/img/loading.gif" lazyload alt="img"></p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E6%8A%80%E6%9C%AF/" class="category-chain-item">技术</a></span></span></div></div><div class="license-box my-3"><div class="license-title"><div>Windows桌面程序自动化控制之uiautomation模块全面讲解</div><div>http://example.com/2022/06/08/Windows桌面程序自动化控制之uiautomation模块全面讲解/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>MuyanGit</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2022年6月8日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2022/07/15/Vm%E5%AE%89%E8%A3%85ubuntu%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AE/" title="Vm安装ubuntu以及配置"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Vm安装ubuntu以及配置</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2022/01/22/Python%E4%B8%AD%E5%86%85%E7%BD%AE%E7%9A%84%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97logging%E7%94%A8%E6%B3%95%E8%AF%A6%E8%A7%A3/" title="Python中内置的日志模块logging用法详解"><span class="hidden-mobile">Python中内置的日志模块logging用法详解</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.4.17/Valine.min.js",function(){var i=Object.assign({appId:"wrsI8VLOqU4aU1Bf7ax2ybPp-MdYXbMMI",appKey:"AEijWlUoG3pMbyJKxexAmJtN",path:"window.location.pathname",placeholder:null,avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!1,recordIP:!1,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})})})</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访客数 <span id="leancloud-site-uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing,t=t.getElementById("subtitle");t&&e&&e(t.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-t}),0<o.find(".toc-list-item").length&&o.css("visibility","visible"))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o,n=[];for(o of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))n.push(".markdown-body > "+o.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))})</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>